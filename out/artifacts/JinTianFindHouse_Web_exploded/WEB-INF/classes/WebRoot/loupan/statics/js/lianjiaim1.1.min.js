!function(){!function(e){"use strict";function u(e,t){var a=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(a>>16)<<16|65535&a}function r(e,t,a,i,n,o){return u(function(e,t){return e<<t|e>>>32-t}(u(u(t,e),u(i,o)),n),a)}function p(e,t,a,i,n,o,s){return r(t&a|~t&i,e,t,n,o,s)}function h(e,t,a,i,n,o,s){return r(t&i|a&~i,e,t,n,o,s)}function m(e,t,a,i,n,o,s){return r(t^a^i,e,t,n,o,s)}function g(e,t,a,i,n,o,s){return r(a^(t|~i),e,t,n,o,s)}function d(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var a,i,n,o,s,r=1732584193,d=-271733879,c=-1732584194,l=271733878;for(a=0;a<e.length;a+=16)d=g(d=g(d=g(d=g(d=m(d=m(d=m(d=m(d=h(d=h(d=h(d=h(d=p(d=p(d=p(d=p(n=d,c=p(o=c,l=p(s=l,r=p(i=r,d,c,l,e[a],7,-680876936),d,c,e[a+1],12,-389564586),r,d,e[a+2],17,606105819),l,r,e[a+3],22,-1044525330),c=p(c,l=p(l,r=p(r,d,c,l,e[a+4],7,-176418897),d,c,e[a+5],12,1200080426),r,d,e[a+6],17,-1473231341),l,r,e[a+7],22,-45705983),c=p(c,l=p(l,r=p(r,d,c,l,e[a+8],7,1770035416),d,c,e[a+9],12,-1958414417),r,d,e[a+10],17,-42063),l,r,e[a+11],22,-1990404162),c=p(c,l=p(l,r=p(r,d,c,l,e[a+12],7,1804603682),d,c,e[a+13],12,-40341101),r,d,e[a+14],17,-1502002290),l,r,e[a+15],22,1236535329),c=h(c,l=h(l,r=h(r,d,c,l,e[a+1],5,-165796510),d,c,e[a+6],9,-1069501632),r,d,e[a+11],14,643717713),l,r,e[a],20,-373897302),c=h(c,l=h(l,r=h(r,d,c,l,e[a+5],5,-701558691),d,c,e[a+10],9,38016083),r,d,e[a+15],14,-660478335),l,r,e[a+4],20,-405537848),c=h(c,l=h(l,r=h(r,d,c,l,e[a+9],5,568446438),d,c,e[a+14],9,-1019803690),r,d,e[a+3],14,-187363961),l,r,e[a+8],20,1163531501),c=h(c,l=h(l,r=h(r,d,c,l,e[a+13],5,-1444681467),d,c,e[a+2],9,-51403784),r,d,e[a+7],14,1735328473),l,r,e[a+12],20,-1926607734),c=m(c,l=m(l,r=m(r,d,c,l,e[a+5],4,-378558),d,c,e[a+8],11,-2022574463),r,d,e[a+11],16,1839030562),l,r,e[a+14],23,-35309556),c=m(c,l=m(l,r=m(r,d,c,l,e[a+1],4,-1530992060),d,c,e[a+4],11,1272893353),r,d,e[a+7],16,-155497632),l,r,e[a+10],23,-1094730640),c=m(c,l=m(l,r=m(r,d,c,l,e[a+13],4,681279174),d,c,e[a],11,-358537222),r,d,e[a+3],16,-722521979),l,r,e[a+6],23,76029189),c=m(c,l=m(l,r=m(r,d,c,l,e[a+9],4,-640364487),d,c,e[a+12],11,-421815835),r,d,e[a+15],16,530742520),l,r,e[a+2],23,-995338651),c=g(c,l=g(l,r=g(r,d,c,l,e[a],6,-198630844),d,c,e[a+7],10,1126891415),r,d,e[a+14],15,-1416354905),l,r,e[a+5],21,-57434055),c=g(c,l=g(l,r=g(r,d,c,l,e[a+12],6,1700485571),d,c,e[a+3],10,-1894986606),r,d,e[a+10],15,-1051523),l,r,e[a+1],21,-2054922799),c=g(c,l=g(l,r=g(r,d,c,l,e[a+8],6,1873313359),d,c,e[a+15],10,-30611744),r,d,e[a+6],15,-1560198380),l,r,e[a+13],21,1309151649),c=g(c,l=g(l,r=g(r,d,c,l,e[a+4],6,-145523070),d,c,e[a+11],10,-1120210379),r,d,e[a+2],15,718787259),l,r,e[a+9],21,-343485551),r=u(r,i),d=u(d,n),c=u(c,o),l=u(l,s);return[r,d,c,l]}function c(e){var t,a="",i=32*e.length;for(t=0;t<i;t+=8)a+=String.fromCharCode(e[t>>5]>>>t%32&255);return a}function l(e){var t,a=[];for(a[(e.length>>2)-1]=void 0,t=0;t<a.length;t+=1)a[t]=0;var i=8*e.length;for(t=0;t<i;t+=8)a[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return a}function i(e){var t,a,i="0123456789abcdef",n="";for(a=0;a<e.length;a+=1)t=e.charCodeAt(a),n+=i.charAt(t>>>4&15)+i.charAt(15&t);return n}function a(e){return unescape(encodeURIComponent(e))}function n(e){return function(e){return c(d(l(e),8*e.length))}(a(e))}function o(e,t){return function(e,t){var a,i,n=l(e),o=[],s=[];for(o[15]=s[15]=void 0,16<n.length&&(n=d(n,8*e.length)),a=0;a<16;a+=1)o[a]=909522486^n[a],s[a]=1549556828^n[a];return i=d(o.concat(l(t)),512+8*t.length),c(d(s.concat(i),640))}(a(e),a(t))}e.md5=function(e,t,a){return t?a?o(t,e):function(e,t){return i(o(e,t))}(t,e):a?n(e):function(e){return i(n(e))}(e)}}(this);var d={timeOffset:0,noop:function(){},makeRequestHeader:function(e,t,a){var i,n,o={},s={},r="";return s=$.extend({"Lianjia-Access-Token":e["Lianjia-Access-Token"]||"1","Lianjia-Device-Id":e.uuid||"","Lianjia-Im-Timestamp":(new Date).getTime()-this.timeOffset},e),o=$.extend(o,s),delete(o=$.extend(o,t))["Lianjia-Uuid"],i=o,n=[],$.each(i,function(e,t){n.push(e+"="+t)}),n.sort(),r=n.join("&"),s["Lianjia-Im-Signature"]=md5(r+a),s}};function c(e,t){this.imInstance=t,this.id=e.conv_id,this.type=e.conv_type,this.title=e.conv_title,this.subtitle=e.conv_subtitle,this.avatar=e.conv_avatar,this.readMsgId=e.read_msg_id,this.mTime=e.mtime,this.peer=e.peer,this.summary=e.summary,Object.defineProperty(this,"_originalObject",{value:e,enumerable:!1})}function l(e,t){this.imInstance=t,this.convId=e.msg.conv_id,this.convType=e.msg.conv_type,this.fromUcid=e.msg.from_ucid,this.id=e.msg.msg_id,this.localId=e.msg.msg_local_id,this.payload=e.msg.msg_payload,this.type=e.msg.msg_type,this.sendTime=e.msg.send_time,this.seq=e.seq,this.summary=e.msg.msg_summary,Object.defineProperty(this,"_originalObject",{value:e,enumerable:!1})}function t(){this._listener={}}function e(e){if(this._events=new t,this.appkey=e.appkey,this.msgApiRoot=e.msgApiRoot,this.mediaApiRoot=e.mediaApiRoot,this.configHeader=e.apiheader,this.ucid=e.ucid,this.port=null,this.extAttr=null,this.convMap={},this.currentSeq=-1,this.msgTimer=0,this.msgTimerLevel=0,this.initMsgWindow={},this.triggerSyncTimer=null,this.state=0,!this.appkey)throw new Error("IM need appkey")}c.prototype={constructor:c,fetchDetail:function(t){var a=this;t=t||d.noop;var e={conv_id:this.id};$.ajax({url:this.imInstance.msgApiRoot+"/conv/detail/fetch",headers:d.makeRequestHeader(this.imInstance.configHeader,e,this.imInstance.appkey),data:e,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw t(null,a),new Error(e.error);t(e.data,a)},error:function(){throw t(null,a),new Error("/conv/detail/fetch ajax fail.")}})},updateDetail:function(){var t=this;this.id;this.fetchDetail(function(e){t.id=e.conv_id,t.type=e.conv_type,t.title=e.conv_title,t.subtitle=e.conv_subtitle,t.avatar=e.conv_avatar,t.readMsgId=e.read_msg_id,t.mTime=e.mtime,t.peer=e.peer,t.summary=e.summary})}},l.prototype={constructor:l},t.prototype={constructor:t,addListener:function(e,t){void 0===this._listener[e]&&(this._listener[e]=[]),"function"==typeof t&&this._listener[e].push(t)},removeListener:function(e,t){var a=this._listener[e];if("function"==typeof t)for(var i=0,n=a.length;i<n;i++)t===a[i]&&a.splice(i,1);else void 0===t&&delete this._listener[e]},fireEvent:function(e,t,a){var i=this._listener[e],n=[{type:e,target:a,param:t}];if(i)for(var o=0,s=i.length;o<s;o++)"function"==typeof i[o]&&(t instanceof Array&&(n=n.concat(t)),i[o].apply(this,n))}},e.prototype={constructor:e,initialize:function(){var t=this;function a(){$.ajax({url:t.msgApiRoot+"/config/sync",headers:d.makeRequestHeader(t.configHeader,{},t.appkey),data:{},dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw i(),new Error(e.error);i(e.data.poll.windows)},error:function(){throw i(),new Error("/config/sync ajax fail.")}})}function i(e){t.initMsgWindow=e||[{interval:3,count:10},{interval:6,count:10},{interval:15,count:8},{interval:30,count:4},{interval:60,count:-1}],t.syncConv(0,100,function(e){t.state=1,t.fire("init",[t]),t.triggerSyncMsg(t.currentSeq)})}$.ajax({url:this.msgApiRoot+"/time/sync",headers:d.makeRequestHeader(this.configHeader,{},this.appkey),data:{},dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw d.timeOffset=0,a(),new Error(e.error);d.timeOffset=Math.round(+new Date-e.data.timestamp),t.timeOffset=d.timeOffset,a()},error:function(){throw d.timeOffset=0,a(),new Error("/time/sync ajax fail.")}}),/^(http|https)?:\/\/\w+\.lianjia\.com/.test(location.href)||"1"===this.configHeader["Lianjia-Access-Token"]||$.ajax({url:this.mediaApiRoot+"/cookie",headers:d.makeRequestHeader(this.configHeader,{},this.appkey),data:{},dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw new Error(e.error)},error:function(){throw new Error("/cookie ajax fail.")}})},syncConv:function(e,t,a){var o=this;!function(t,a,i){var n=arguments.callee,e={offset:t,limit:a};$.ajax({url:o.msgApiRoot+"/user/conv/list",headers:d.makeRequestHeader(o.configHeader,e,o.appkey),data:e,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw i(null,o),new Error(e.error);$.each(e.data.list,function(){o.convMap[this.conv_id]=new c(this,o)}),t+e.data.list.length<e.data.total_count&&0<e.data.list.length?n(t+a,a,i):i(o.convMap,o)},error:function(){throw i(null,o),new Error("/user/conv/list ajax fail.")}})}(e,t,a=a||d.noop)},syncMsg:function(e){var s=this,r=this.msgTimerLevel=0;!function(t){clearTimeout(s.msgTimer);var e={},o=arguments.callee;-1===t?(e.rev_seq=t,e.seq=0):e.seq=t,$.ajax({url:s.msgApiRoot+"/msg/sync",headers:d.makeRequestHeader(s.configHeader,e,s.appkey),data:e,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},timeout:1e4,cache:!0,success:function(e){if(0!==e.errno)throw s.msgTimer=setTimeout(function(){o(s.currentSeq)},1e3*s.initMsgWindow[s.msgTimerLevel].interval),new Error(e.error);if(0<e.data.list.length){s.currentSeq=e.data.list[e.data.list.length-1].seq;var a=[],i=[],n=[];$.each(e.data.list,function(){var t=new l(this,s);switch(s.convMap[t.convId]||0===t.convId||(s.convMap[t.convId]={},s.fetchConversation(t.convId,function(e){s.convMap[t.convId]=new c(e,s)})),t.type){case 100:i.push(t);break;case 101:n.push(t);break;default:a.push(t)}}),0<a.length&&s.fire("message",[a,t]),0<i.length&&s.fire("arrive",[i,t]),0<n.length&&s.fire("read",[n,t]),r=0,s.msgTimerLevel=0}1===e.data.has_more?o(s.currentSeq):(-1===s.initMsgWindow[s.msgTimerLevel].count?r=0:r>=s.initMsgWindow[s.msgTimerLevel].count&&(r=0,s.msgTimerLevel=Math.min(s.msgTimerLevel+1,s.initMsgWindow.length-1)),r++,s.msgTimer=setTimeout(function(){o(s.currentSeq)},1e3*s.initMsgWindow[s.msgTimerLevel].interval)),-1===t&&s.fire("start",[s])},error:function(){throw s.msgTimer=setTimeout(function(){o(s.currentSeq)},1e3*s.initMsgWindow[s.msgTimerLevel].interval),new Error("/msg/sync ajax fail.")}})}(e)},triggerSyncMsg:function(e){var t=this;this.triggerSyncTimer&&clearTimeout(this.triggerSyncTimer),this.triggerSyncTimer=setTimeout(function(){t.syncMsg(e)},100)},create:function(e,t,a){var i=this,n="",o={};if(a=a||d.noop,e instanceof Array){if(1<e.length)throw new Error("Error #42002: conv_type === 1 only allow 2 members. Please see http://wiki.lianjia.com/pages/viewpage.action?pageId=9899018 .");n=e.join(",")}else n=e;if(n===this.ucid)throw new Error("Error #42003: conv_type === 1 can't talk to self. Please see http://wiki.lianjia.com/pages/viewpage.action?pageId=9899018 .");1===t?(o={members:e,conv_type:t},$.ajax({url:i.msgApiRoot+"/conv/create",headers:d.makeRequestHeader(this.configHeader,o,this.appkey),data:o,dataType:"json",method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw a(null,i),new Error(e.error);var t=new c(e.data,i);i.convMap[t.id]=t,a(t,i)},error:function(){throw a(null,i),new Error("/conv/create ajax fail.")}})):(o={members:n,conv_type:t},$.ajax({url:i.msgApiRoot+"/conv/create",headers:d.makeRequestHeader(this.configHeader,o,this.appkey),data:o,dataType:"json",method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw a(null,i),new Error(e.error);var t=new c(e.data,i);i.convMap[t.id]=t,a(t,i)},error:function(){throw a(null,i),new Error("/conv/create ajax fail.")}}))},convEnter:function(e){var t={conv_id:e,msg_attr:JSON.stringify({biz_src:Object.assign({},{port:this.port},this.extAttr)})};e&&$.ajax({url:this.msgApiRoot+"/conv/enter",headers:d.makeRequestHeader(this.configHeader,t,this.appkey),data:t,dataType:"json",method:"POST",success:function(e){},error:function(e){throw new Error("/conv/enter ajax fail.")}})},recallMsg:function(t){if(t&&t.conv_id&&t.msg_id){var e={conv_id:t.conv_id,msg_id:t.msg_id};$.ajax({url:this.msgApiRoot+"/msg/recall",headers:d.makeRequestHeader(this.configHeader,e,this.appkey),data:e,dataType:"json",method:"POST",success:function(e){cb=t.callback,0===e.errno?cb&&cb(e.data):cb&&cb()},error:function(e){}})}},talkTo:function(t,a,i){var n=this;i=i||d.noop,this.getTalk(t,function(e){e?n.sendTo(e.id,a,i):n.create(t,1,function(e){n.sendTo(e.id,a,i)})})},get330card:function(e,t){$.ajax({url:this.msgApiRoot+"/card",headers:d.makeRequestHeader(this.configHeader,e,this.appkey),data:e,dataType:"json",method:"get",contentType:"application/x-www-form-urlencoded",xhrFields:{withCredentials:!0},success:function(e){0===e.errno&&t(e)}})},send330:function(e,t,a){var i=this,n={conv_id:e,msg_local_id:t.localId||+new Date,msg_type:t.type,msg_payload:t.payload},o="";(i.port||i.extAttr)&&(o=JSON.stringify({biz_src:Object.assign({},{port:i.port},i.extAttr)})),o&&(n.msg_attr=o),a=a||d.noop,$.ajax({url:this.msgApiRoot+"/msg/send",headers:d.makeRequestHeader(this.configHeader,n,this.appkey),data:n,dataType:"json",method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw a(null,i),new Error(e.error);a(e)},error:function(){throw a(null,i),new Error("/msg/send ajax fail.")}})},sendTo:function(e,a,i){var n=this,t={conv_id:e,msg_local_id:a.localId||+new Date,msg_type:a.type,msg_payload:a.payload},o="";(n.port||n.extAttr)&&(o=JSON.stringify({biz_src:Object.assign({},{port:n.port},n.extAttr)})),o&&(t.msg_attr=o),i=i||d.noop,$.ajax({url:this.msgApiRoot+"/msg/send",headers:d.makeRequestHeader(this.configHeader,t,this.appkey),data:t,dataType:"json",method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw i(null,n,e),new Error(e.error);var t=new l({msg:{conv_id:e.data.conv_id,msg_id:e.data.msg_id,msg_local_id:e.data.msg_local_id,send_time:e.data.send_time,from_ucid:n.ucid,msg_payload:a.payload,msg_type:a.type},seq:-1},n);i(t,n),n.triggerSyncMsg(n.currentSeq)},error:function(){throw i(null,n),new Error("/msg/send ajax fail.")}})},uploadPicture:function(e,t,a){var i=this,n=new FormData;n.append("conv_id",e),n.append("image",t),$.ajax({url:this.mediaApiRoot+"/image/upload",headers:d.makeRequestHeader(this.configHeader,{},this.appkey),data:n,dataType:"json",processData:!1,contentType:!1,method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw a(null,i),new Error(e.error);a(JSON.stringify(e.data),i)},error:function(){throw a(null,i),new Error("/image/upload ajax fail.")}})},markRead:function(e,t){var a=this,i={conv_id:e.convId,msg_id:e.id};t=t||d.noop,$.ajax({url:this.msgApiRoot+"/msg/read",headers:d.makeRequestHeader(this.configHeader,i,this.appkey),data:i,dataType:"json",method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw t(null,a),new Error(e.error);t(e.data,a)},error:function(){throw t(null,a),new Error("/msg/read ajax fail.")}})},fetchConversation:function(e,t){var a=this,i={conv_id:e};t=t||d.noop,$.ajax({url:this.msgApiRoot+"/conv/detail/fetch",headers:d.makeRequestHeader(this.configHeader,i,this.appkey),data:i,dataType:"json",method:"GET",async:!1,xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw t(null,a),new Error(e.error);t(e.data,a)},error:function(){throw t(null,a),new Error("/conv/detail/fetch ajax fail.")}})},getTalk:function(e,t){t=t||d.noop;var a=null;$.each(this.convMap,function(){if(1===this.conv_type&&this.peer.ucid===e)return a=this,!1}),t(a,this)},getHistory:function(e,i){var n=this;i=i||d.noop,$.ajax({url:this.msgApiRoot+"/msg/list",headers:d.makeRequestHeader(this.configHeader,e,this.appkey),data:e,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw i(null,n),new Error(e.error);var t=e.data.list,a=[];$.each(t,function(){a.push(new l({msg:this},n))}),i(a,n)},error:function(){throw i(null,n),new Error("/msg/list ajax fail.")}})},accuse:function(e,t){var a=this,i=e;t=t||d.noop,$.ajax({url:this.msgApiRoot+"/guangsha/report",headers:d.makeRequestHeader(this.configHeader,i,this.appkey),data:i,dataType:"json",method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw t(null,a),new Error(e.error);t(e)},error:function(){throw t(null,a),new Error("/guangsha/report ajax fail.")}})},fetchReportStatus:function(e,t){var a=this,i={conv_id:e};t=t||d.noop,$.ajax({url:this.msgApiRoot+"/user/status/fetch",headers:d.makeRequestHeader(this.configHeader,i,this.appkey),data:i,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw t(null,a),new Error(e.error);t(e)},error:function(){throw t(null,a),new Error("/guangsha/report ajax fail.")}})},getUsersInfo:function(e,t){var a=this;t=t||d.noop,$.ajax({url:this.msgApiRoot+"/user/detail/fetch",headers:d.makeRequestHeader(this.configHeader,e,this.appkey),data:e,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw t(null,a),new Error(e.error);t(e.data.list,a)},error:function(){throw t(null,a),new Error("/user/detail/fetch")}})},IMNotification:function(t,a){if("string"!=typeof t.title||"string"!=typeof t.body)throw new Error("opt.title and opt.body is must be string!");var i=window.Notification||window.mozNotification||window.webkitNotification,n=null,o={dir:"auto",lang:"zh-CN",tag:Date.now(),icon:t.icon,body:t.body};(i&&("granted"===i.permission?n=new i(t.title,o):"denied"!==i.permission&&"default"!==i.permission||i.requestPermission(function(e){"granted"===e&&(n=new i(t.title,o))})),n)?(n.onclick=function(){window.focus()},n.onshow=function(){"Audio"in window&&new Audio(a+"/static/two beat.wav").play();var e=setTimeout(function(){n.close?n.close():n.close.bind(n),clearTimeout(e)},3e3)},n.onerror=function(){},n.onclose=function(){}):"Audio"in window&&new Audio(a+"/static/two beat.wav").play()},encodeHtml:function(e){return(e+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")},on:function(e,t){this._events.addListener(e,t)},off:function(e,t){this._events.removeListener(e,t)},fire:function(e,t){this._events.fireEvent(e,t,this)},destory:function(){this.fire("destory",[this]),clearTimeout(this.msgTimer),delete this._events._listener}},window.ImCore=e}(),function(e,t,a){var i=a(t);"function"==typeof define&&define.amd?define(function(){return i}):"object"==typeof exports?i.exports=i:t[e]=i,window[e]=i}("LianjiaIM",this,function(){function _EventEmitter(){"use strict";var a,n,o,s,r;function d(){}return"function"!=typeof Object.create&&(Object.create=(a=function(){},function(e){if(1<arguments.length)throw Error("Second argument not supported");if("object"!=typeof e)throw TypeError("Argument must be an object");a.prototype=e;var t=new a;return a.prototype=null,t})),Object.keys||(Object.keys=(n=Object.prototype.hasOwnProperty,o=!{toString:null}.propertyIsEnumerable("toString"),r=(s=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"]).length,function(e){if("object"!=typeof e&&("function"!=typeof e||null===e))throw new TypeError("Object.keys called on non-object");var t,a,i=[];for(t in e)n.call(e,t)&&i.push(t);if(o)for(a=0;a<r;a++)n.call(e,s[a])&&i.push(s[a]);return i})),d.extend=function(e){var t=this,n=t.prototype;function a(){this&&t(this,arguments),this&&this._initialize_&&this._initialize_.apply(this,arguments)}var i=a.prototype=Object.create(n);for(var o in e){if("constructor"===o)return;var s=e[o];if("function"==typeof s&&n[o]&&"function"==typeof n[o])s=function(a,i){return function(){var e=this._super;this._super=n[a];var t=i.apply(this,arguments);return this._super=e,t}}(o,s);else if("object"==typeof s&&n[o]&&"object"==typeof n[o])for(var r in n[o])s[r]||(s[r]=n[o][r]);i[o]=s}return a.extend=d.extend,a},d.extend({_initialize_:function(e){this._eventList={},this._eventTriggerd_={},this.initialize&&this.initialize.apply(this,arguments),this._promise_="boolean"==typeof e&&e},on:function(e,t){if(!e||!t)throw"type of fn is required";var a=this._eventList[e];a||(a=[],this._eventList[e]=a),a.push(t)},off:function(e,t){if(e){var a=this._eventList[e];if(a&&a.length){if(!t){for(;a.pop(););return}for(var i=0,n=a.length;i<n;i++)if(a[i]==t||a[i]==t.fn)return void a.splice(i,1)}}else this._eventList={}},trigger:function(e){if(e){var t=Array.prototype.slice.call(arguments,1);this._promise_&&(this._eventTriggerd_[e]=t);var a=this._eventList[e];if(a&&a.length)for(var i=0;i<a.length;i++)if(!1===a[i].apply(this,t))return!1}},before:function(e,t){var a,i=this;return function(){return 0<--e?a=t.apply(i,arguments):t=null,a}},once:function(e,t){e&&t&&this.on(e,this.before(2,t))},destroy:function(){this._eventList=null},always:function(e,t){this.on(e,t),this._eventTriggerd_[e]&&t.apply(null,this._eventTriggerd_[e])}})}function _Trans(){function t(e){if(!(this instanceof t))return new t(e);this.opt=$.extend({url:"",method:"get",dataType:"json",validateCode:!0,args:{},type:"ajax"},e),"jsonp"==this.opt.type&&(this.opt.dataType="jsonp")}return $.extend(t.prototype,{request:function(e,t){var a={success:$.noop,fail:$.noop,timeout:$.noop,timeout:15e3};$.extend(a,t);var i=$.Deferred(),n=this;$.extend(n.opt.args,e);$.ajax({url:n.opt.url,type:n.opt.method,dataType:n.opt.dataType,data:n.opt.args,timeout:n.opt.timeout}).success(function(e){if(!0===n.opt.validateCode&&e&&"code"in e){if(1!=e.code)return void i.reject(e);if(-1==e.code)return void($.listener&&$.listener.trigger("unlogin"));e.data&&!$.isArray(e.data)&&(e=e.data)}i.resolve(e)}).fail(function(e){i.reject(e)});return i},setArgs:function(e){$.extend(this.opt.args,e)}}),t}function _getCommonEnv(){var i={host:"",scheme:"",port:"",env:"online"};var n={getEnv:function(){return i.env},fixedHost:function(e){if(!e)return i.host;var t=e.substring(0,e.indexOf("."));switch(i.env){case"dev":case"test":if(0!==t.indexOf(i.env))return i.env+e}return e},fixedUrl:function(e,t){t=t||!1,e.indexOf("http")<0&&(e=location.protocol+e);var a=$.parseURL(e);return a.host?(!t&&(a.host=n.fixedHost(a.host)),a.port=i.port,a.scheme||(a.scheme=i.scheme)):(a.host=i.host,a.scheme=i.scheme,a.port=i.port),function(e){var t="";return e.scheme&&(t+=e.scheme+"://"),e.host&&(t+=e.host),e.port&&(t+=":"+e.port),e.path&&(t+="/"+e.path),e.query&&(t+="?"+e.query),e.hash&&(t+="#"+e.hash),t}(a)},isSameDomain:function(e){return $.parseURL(e).host==i.host}};return function(){var e=$.parseURL(location.href);i.host=e.host,i.scheme=e.scheme,i.port=e.port;var t=i.host.match(/.*\.(lianjia|ke)\.com/)[1];0===t.indexOf("dev")?i.env="dev":0===t.indexOf("test")&&(i.env="test")}(),$.env=n}function _pushMessage(e){return function(n){var e=$.env.fixedUrl("//ajax.lianjia.com/ajax/user/favorite/getnotifynum/"),o={house_showing:{url:"//user.lianjia.com/site/seeSchedule",text:'你的看房日程有<span class="unreadNumber">#{unread}</span>条更新'},community_new_house_source:{url:"//user.lianjia.com/?filter=3",text:'你关注的小区有<span class="unreadNumber">#{unread}</span>条新上'},deal:{url:"//user.lianjia.com/?filter=1",text:'你关注的房源有<span class="unreadNumber">#{unread}</span>条成交'},price_changed:{url:"//user.lianjia.com/?filter=2",text:'你关注的房源有<span class="unreadNumber">#{unread}</span>条变价'},"search:new":{url:"//user.lianjia.com/?filter=4",text:'你保存的搜索条件有<span class="unreadNumber">#{unread}</span>条变动'},on_answer_insert_concern:{url:"//user.lianjia.com/site/myWenda/?filter=1",text:'您关注的问题有<span class="unreadNumber">#{unread}</span>条回复'},on_answer_insert:{url:"//user.lianjia.com/site/myWenda/",text:'您提问的问题有<span class="unreadNumber">#{unread}</span>条回复'},on_extra_answer_pass:{url:"//user.lianjia.com/site/myWenda/?filter=2",text:'您收到<span class="unreadNumber">#{unread}</span>条新追答'},on_special_question_pass:{url:"//user.lianjia.com/site/myWenda/?filter=3",text:'您收到<span class="unreadNumber">#{unread}</span>条定向提问'},on_extra_question_pass:{url:"//user.lianjia.com/site/myWenda/?filter=4",text:'您收到<span class="unreadNumber">#{unread}</span>条追问'},xuequ_bbs:{url:"//user.lianjia.com/site/bbs?type=4",text:'论坛有<span class="unreadNumber">#{unread}</span>条回复'},ting_shou:{url:"//user.lianjia.com/",text:'您关注的<span class="unreadNumber">#{unread}</span>套房源已下架'}},s=$.extend({},o,{on_extra_answer_pass:{url:"//agent.lianjia.com/preference/wenda/?filter=2",text:'您收到<span class="unreadNumber">#{unread}</span>条新追答'},on_special_question_pass:{url:"//agent.lianjia.com/preference/wenda/?filter=3",text:'您收到<span class="unreadNumber">#{unread}</span>条定向提问'},on_extra_question_pass:{url:"//agent.lianjia.com/preference/wenda/?filter=4",text:'您收到<span class="unreadNumber">#{unread}</span>条追问'}});$.ajax({url:e,type:"get",dataType:"jsonp",success:function(e){if(0===e.errno){var t=e.data.is_agent?s:o,a=0;for(var i in e.data.group_by_type)0!==e.data.group_by_type[i].unread&&t.hasOwnProperty(i)&&(a+=e.data.group_by_type[i].unread);0!==a&&(n.tipContainer.html(n.tipTpl.render({unreadNum:a})),n.container.html(n.msgTpl.render({group_by_type:e.data.group_by_type,pushMsgMap:t})))}}})}}function _crossRequest(){var o=new LJMessenger("LIANJIA_CROSS_MESSAGE","LIANJIA-CROSS");o.listen(function(e){var t=(e=JSON.parse(e)).name;o.targets[t]&&("state"==e.type?(o.targets[t].readyState="ready",o.targets[t].dealReady()):o.targets[t].deal(e.data,e.success))});var a={},i=function(e,t){this.domain=e,t=t||$.parseURL(e).host.replace(/\./g,"-"),this.name=t,this.init()};return $.extend(i.prototype,{init:function(){var n=this,e=n.domain+"/xd/api/?name="+n.name,t=function(e,t){var a=document.createElement("iframe");return a.id=e,a.name=e,a.src=t,a.style.cssText="display:none;width:0px;height:0px;",a.width=0,a.height=0,a.title="empty",document.body.appendChild(a),a}(n.name,e);n.iframe=t.contentWindow,o.addTarget(n.iframe,n.name),n.reqArray=[],o.targets[n.name].deal=function(e,t){o.targets[n.name].isRequest=!1;var a=n.reqArray.shift(),i=!1;try{i=e}catch(e){}t?a.defer.resolve(i):a.defer.reject(i),n.next()},o.targets[n.name].dealReady=function(){n.next()}},next:function(){var e=this;if(o.targets[e.name].readyState&&e.reqArray.length&&!o.targets[e.name].isRequest){o.targets[e.name].isRequest=!0;var t={type:"request",data:e.reqArray[0].request},a=JSON.stringify(t);o.targets[e.name].send(a)}},request:function(e){var t=$.Deferred();return this.reqArray.push({defer:t,request:e}),this.next(),t}}),function(e,t){return a[e]?a[e]:a[e]=new i(e,t)}}function _trans(){var e=$.EventEmitter,i=_crossRequest(),n=_getCommonEnv();return e.extend({initialize:function(e){var t={url:"",type:"get",dataType:"json",args:{}};$.extend(t,e),t.url=n.fixedUrl(t.url),t.method=t.type;this.opt=t;var a=n.fixedUrl($.parseURL(t.url).host);n.isSameDomain(a)?this.isSame=!0:this.crossRequest=i(a)},request:function(e){var t=this.opt;return $.extend(t.args,e),t.data=t.args,this.isSame?$.ajax(t):this.crossRequest.request(t)}})}function _sticker(){return[{face:"0",chara:"[微笑]",code:"/::)"},{face:"1",chara:"[伤心]",code:"/::~"},{face:"2",chara:"[美女]",code:"/::B"},{face:"3",chara:"[发呆]",code:"/::|"},{face:"4",chara:"[墨镜]",code:"/:8-)"},{face:"5",chara:"[哭]",code:"/::<"},{face:"6",chara:"[羞]",code:"/::$"},{face:"7",chara:"[哑]",code:"/::X"},{face:"8",chara:"[睡]",code:"/::Z"},{face:"9",chara:"[小哭]",code:"/::'("},{face:"10",chara:"[囧]",code:"/::-|"},{face:"11",chara:"[怒]",code:"/::@"},{face:"12",chara:"[调皮]",code:"/::P"},{face:"13",chara:"[笑]",code:"/::D"},{face:"14",chara:"[惊讶]",code:"/::O"},{face:"15",chara:"[难过]",code:"/::("},{face:"16",chara:"[酷]",code:"/::+"},{face:"17",chara:"[汗]",code:"/:--b"},{face:"18",chara:"[抓狂]",code:"/::Q"},{face:"19",chara:"[吐]",code:"/::T"},{face:"20",chara:"[大笑]",code:"/:,@P"},{face:"21",chara:"[快乐]",code:"/:,@-D"},{face:"22",chara:"[奇]",code:"/::d"},{face:"23",chara:"[傲]",code:"/:,@o"},{face:"24",chara:"[饿]",code:"/::g"},{face:"25",chara:"[累]",code:"/:|-)"},{face:"26",chara:"[吓]",code:"/::!"},{face:"27",chara:"[小汗]",code:"/::L"},{face:"28",chara:"[高兴]",code:"/::>"},{face:"29",chara:"[闲]",code:"/::,@"},{face:"30",chara:"[努力]",code:"/:,@f"},{face:"31",chara:"[骂]",code:"/::-S"},{face:"32",chara:"[疑问]",code:"/:?"},{face:"33",chara:"[秘密]",code:"/:,@x"},{face:"34",chara:"[乱]",code:"/:,@@"},{face:"35",chara:"[疯]",code:"/::8"},{face:"36",chara:"[哀]",code:"/:,@!"},{face:"37",chara:"[鬼]",code:"/:!!!"},{face:"38",chara:"[打击]",code:"/:xx"},{face:"39",chara:"[再见]",code:"/:bye"},{face:"40",chara:"[中汗]",code:"/:wipe"},{face:"41",chara:"[抠]",code:"/:dig"},{face:"42",chara:"[鼓掌]",code:"/:handclap"},{face:"43",chara:"[糟糕]",code:"/:&-("},{face:"44",chara:"[恶搞]",code:"/:B-)"},{face:"45",chara:"[左什么]",code:"/:<@"},{face:"46",chara:"[右什么]",code:"/:@>"},{face:"47",chara:"[小累]",code:"/::-O"},{face:"48",chara:"[看]",code:"/:>-|"},{face:"49",chara:"[委屈]",code:"/:P-("},{face:"50",chara:"[大难过]",code:"/::'|"},{face:"51",chara:"[坏]",code:"/:X-)"},{face:"52",chara:"[亲]",code:"/::*"},{face:"53",chara:"[惊吓]",code:"/:@x"},{face:"54",chara:"[可怜]",code:"/:8*"},{face:"55",chara:"[刀]",code:"/:pd"},{face:"56",chara:"[水果]",code:"/:<W>"},{face:"57",chara:"[酒]",code:"/:beer"},{face:"58",chara:"[篮球]",code:"/:basketb"},{face:"59",chara:"[乒乓]",code:"/:oo"},{face:"60",chara:"[咖啡]",code:"/:coffee"},{face:"61",chara:"[美食]",code:"/:eat"},{face:"62",chara:"[动物]",code:"/:pig"},{face:"63",chara:"[鲜花]",code:"/:rose"},{face:"64",chara:"[枯]",code:"/:fade"},{face:"65",chara:"[唇]",code:"/:showlove"},{face:"66",chara:"[爱]",code:"/:heart"},{face:"67",chara:"[分手]",code:"/:break"},{face:"68",chara:"[生日]",code:"/:cake"},{face:"69",chara:"[电]",code:"/:li"}]}$.template=function(){var rsplit=function(e,t){for(var a,i=t.exec(e),n=new Array;null!=i;)a=i.index,t.lastIndex,0!=a&&(e.substring(0,a),n.push(e.substring(0,a)),e=e.slice(a)),n.push(i[0]),e=e.slice(i[0].length),i=t.exec(e);return""==!e&&n.push(e),n},chop=function(e){return e.substr(0,e.length-1)},extend=function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])},EJS=function(e){if(e="string"==typeof e?{view:e}:e,this.set_options(e),e.precompiled)return this.template={},this.template.process=e.precompiled,void EJS.update(this.name,this);if(e.element){if("string"==typeof e.element){var t=e.element;if(e.element=document.getElementById(e.element),null==e.element)throw t+"does not exist!"}e.element.value?this.text=e.element.value:this.text=e.element.innerHTML,this.name=e.element.id,this.type="["}else if(e.url){e.url=EJS.endExt(e.url,this.extMatch),this.name=this.name?this.name:e.url;var a=e.url;if(i=EJS.get(this.name,this.cache))return i;if(i==EJS.INVALID_PATH)return null;try{this.text=EJS.request(a+(this.cache?"":"?"+Math.random()))}catch(e){}if(null==this.text)throw{type:"EJS",message:"There is no template at "+a}}var i;(i=new EJS.Compiler(this.text,this.type)).compile(e,this.name),EJS.update(this.name,this),this.template=i};return EJS.prototype={render:function(e,t){e=e||{},this._extra_helpers=t;var a=new EJS.Helpers(e,t||{});return this.template.process.call(e,e,a)},update:function(element,options){if("string"==typeof element&&(element=document.getElementById(element)),null==options)return _template=this,function(e){EJS.prototype.update.call(_template,element,e)};"string"==typeof options?(params={},params.url=options,_template=this,params.onComplete=function(request){var object=eval(request.responseText);EJS.prototype.update.call(_template,element,object)},EJS.ajax_request(params)):element.innerHTML=this.render(options)},out:function(){return this.template.out},set_options:function(e){this.type=e.type||EJS.type,this.cache=null!=e.cache?e.cache:EJS.cache,this.text=e.text||null,this.name=e.name||null,this.ext=e.ext||EJS.ext,this.extMatch=new RegExp(this.ext.replace(/\./,"."))}},EJS.endExt=function(e,t){return e?(t.lastIndex=0,e+(t.test(e)?"":this.ext)):null},EJS.Scanner=function(e,t,a){extend(this,{left_delimiter:t+"%",right_delimiter:"%"+a,double_left:t+"%%",double_right:"%%"+a,left_equal:t+"%=",left_comment:t+"%#"}),this.SplitRegexp="["==t?/(\[%%)|(%%\])|(\[%=)|(\[%#)|(\[%)|(%\]\n)|(%\])|(\n)/:new RegExp("("+this.double_left+")|(%%"+this.double_right+")|("+this.left_equal+")|("+this.left_comment+")|("+this.left_delimiter+")|("+this.right_delimiter+"\n)|("+this.right_delimiter+")|(\n)"),this.source=e,this.stag=null,this.lines=0},EJS.Scanner.to_text=function(e){return null==e||void 0===e?"":e instanceof Date?e.toDateString():e.toString?e.toString():""},EJS.Scanner.prototype={scan:function(e){if(scanline=this.scanline,regex=this.SplitRegexp,""==!this.source)for(var t=rsplit(this.source,/\n/),a=0;a<t.length;a++){var i=t[a];this.scanline(i,regex,e)}},scanline:function(e,t,a){this.lines++;for(var i=rsplit(e,t),n=0;n<i.length;n++){var o=i[n];if(null!=o)try{a(o,this)}catch(e){throw{type:"EJS.Scanner",line:this.lines}}}}},EJS.Buffer=function(e,t){this.line=new Array,this.script="",this.pre_cmd=e,this.post_cmd=t;for(var a=0;a<this.pre_cmd.length;a++)this.push(e[a])},EJS.Buffer.prototype={push:function(e){this.line.push(e)},cr:function(){this.script=this.script+this.line.join("; "),this.line=new Array,this.script=this.script+"\n"},close:function(){if(0<this.line.length){for(var e=0;e<this.post_cmd.length;e++)this.push(pre_cmd[e]);this.script=this.script+this.line.join("; "),line=null}}},EJS.Compiler=function(e,t){this.pre_cmd=["var ___ViewO = [];"],this.post_cmd=new Array,this.source=" ",null!=e&&("string"==typeof e?(e=(e=e.replace(/\r\n/g,"\n")).replace(/\r/g,"\n"),this.source=e):e.innerHTML&&(this.source=e.innerHTML),"string"!=typeof this.source&&(this.source=""));var a=">";switch(t=t||"<"){case"[":a="]";break;case"<":break;default:throw t+" is not a supported deliminator"}this.scanner=new EJS.Scanner(this.source,t,a),this.out=""},EJS.Compiler.prototype={compile:function(options,name){options=options||{},this.out="";var put_cmd="___ViewO.push(",insert_cmd=put_cmd,buff=new EJS.Buffer(this.pre_cmd,this.post_cmd),content="",clean=function(e){return e=(e=(e=e.replace(/\\/g,"\\\\")).replace(/\n/g,"\\n")).replace(/"/g,'\\"')};this.scanner.scan(function(e,t){if(null==t.stag)switch(e){case"\n":content+="\n",buff.push(put_cmd+'"'+clean(content)+'");'),buff.cr(),content="";break;case t.left_delimiter:case t.left_equal:case t.left_comment:t.stag=e,0<content.length&&buff.push(put_cmd+'"'+clean(content)+'")'),content="";break;case t.double_left:content+=t.left_delimiter;break;default:content+=e}else switch(e){case t.right_delimiter:switch(t.stag){case t.left_delimiter:"\n"==content[content.length-1]?(content=chop(content),buff.push(content),buff.cr()):buff.push(content);break;case t.left_equal:buff.push(insert_cmd+"(EJS.Scanner.to_text("+content+")))")}t.stag=null,content="";break;case t.double_right:content+=t.right_delimiter;break;default:content+=e}}),0<content.length&&buff.push(put_cmd+'"'+clean(content)+'")'),buff.close(),this.out=buff.script+";";var to_be_evaled="/*"+name+"*/this.process = function(_CONTEXT,_VIEW) { try { with(_VIEW) { with (_CONTEXT) {"+this.out+" return ___ViewO.join('');}}}catch(e){e.lineNumber=null;throw e;}};";try{eval(to_be_evaled)}catch(e){if("undefined"==typeof JSLINT)throw e;JSLINT(this.out);for(var i=0;i<JSLINT.errors.length;i++){var error=JSLINT.errors[i];if("Unnecessary semicolon."!=error.reason){error.line++;var e=new Error;throw e.lineNumber=error.line,e.message=error.reason,options.view&&(e.fileName=options.view),e}}}}},EJS.config=function(e){EJS.cache=null!=e.cache?e.cache:EJS.cache,EJS.type=null!=e.type?e.type:EJS.type,EJS.ext=null!=e.ext?e.ext:EJS.ext;var a=EJS.templates_directory||{};EJS.templates_directory=a,EJS.get=function(e,t){return 0==t?null:a[e]?a[e]:null},EJS.update=function(e,t){null!=e&&(a[e]=t)},EJS.INVALID_PATH=-1},EJS.config({cache:!0,type:"<",ext:".ejs"}),EJS.Helpers=function(e,t){this._data=e,this._extras=t,extend(this,t)},EJS.Helpers.prototype={view:function(e,t,a){return a||(a=this._extras),t||(t=this._data),new EJS(e).render(t,a)},to_text:function(e,t){return null==e||void 0===e?t||"":e instanceof Date?e.toDateString():e.toString?e.toString().replace(/\n/g,"<br />").replace(/''/g,"'"):""}},EJS.newRequest=function(){for(var e=[function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new XMLHttpRequest},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],t=0;t<e.length;t++)try{var a=e[t]();if(null!=a)return a}catch(e){continue}},EJS.request=function(e){var t=new EJS.newRequest;t.open("GET",e,!1);try{t.send(null)}catch(e){return null}return 404==t.status||2==t.status||0==t.status&&""==t.responseText?null:t.responseText},EJS.ajax_request=function(e){e.method=e.method?e.method:"GET";var t=new EJS.newRequest;t.onreadystatechange=function(){4==t.readyState&&(t.status,e.onComplete(t))},t.open(e.method,e.url),t.send(null)},function(e){return new EJS({text:e,type:"<"})}}(),$.Trans=_Trans(),$.EventEmitter=_EventEmitter(),window.LJMessenger=function(){var i="[LIANJIA_Messenger_CROSS]",t="postMessage"in window;function n(e,t){var a="";if(arguments.length<2?a="target error - target and name are both requied":"object"!=typeof e?a="target error - target itself must be window object":"string"!=typeof t&&(a="target error - target name must be string type"),a)throw new Error(a);this.target=e,this.name=t}function e(e,t){this.targets={},this.name=e,this.listenFunc=[],"string"!=typeof(i=t||i)&&(i=i.toString()),this.initListen()}return n.prototype.send=t?function(e){this.target.postMessage(i+e,"*")}:function(e){var t=window.navigator[i+this.name];if("function"!=typeof t)throw new Error("target callback function is not defined");t(i+e,window)},e.prototype.addTarget=function(e,t){var a=new n(e,t);this.targets[t]=a},e.prototype.initListen=function(){var a=this,e=function(e){if("object"==typeof e&&e.data&&(e=e.data),e&&"string"==typeof e&&0<=e.indexOf(i)){e=e.slice(i.length);for(var t=0;t<a.listenFunc.length;t++)a.listenFunc[t](e)}};t?"addEventListener"in document?window.addEventListener("message",e,!1):"attachEvent"in document&&window.attachEvent("onmessage",e):window.navigator[i+this.name]=e},e.prototype.listen=function(e){this.listenFunc.push(e)},e.prototype.clear=function(){this.listenFunc=[]},e.prototype.send=function(e){var t,a=this.targets;for(t in a)a.hasOwnProperty(t)&&a[t].send(e)},e}(),$.parseURL&&"[object Function]"===Object.prototype.toString.call($.parseURL)||($.parseURL=function(e){if(!e)return null;for(var t=["url","origin","scheme","slash","host","port","path","query","hash"],a=/^((?:([A-Za-z]+):(\/{0,3}))?([0-9.\-A-Za-z]+\.[0-9A-Za-z]+)?(?::(\d+))?)(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.exec(e),i={},n=0,o=t.length;n<o;n+=1)i[t[n]]=a[n]||"";return i});var sticker=_sticker,$win=$(window),$body=$(document.body),apiRoot=function(){for(var e=window.location.host,t=["dev","test","offline","self","selfnew","beta"],a=null;(a=t.pop())&&!(0<=e.indexOf(a)););return{ljApi:{dev:"http://ajax.testapi.lianjia.com:7081/",test:"http://ajax.testapi.lianjia.com/",prod:"//ajax.api.lianjia.com/"}[a=a?"test":"prod"],imApi:{dev:{msg:"https://imapi-test.lianjia.com",media:"https://imm-test.lianjia.com"},test:{msg:"https://imapi-test.lianjia.com",media:"https://imm-test.lianjia.com"},prod:{msg:"https://imapi.lianjia.com",media:"https://imm.lianjia.com"}}[a],satisfaction:{dev:"http://imscheduler.sinan.off.test.lianjia.com:10103/webchat/satisfaction",test:"http://imscheduler.sinan.off.test.lianjia.com:10103/webchat/satisfaction",prod:"https://ajax.api.lianjia.com/web/remark/satisfaction"}[a],xfApi:{dev:"http://10.30.128.254:8050/",test:"http://test5-newhouseapi.fang.lianjia.com/",prod:"//newhouseapi.ke.com/"}[a],zulinApi:{dev:"http://10.30.129.193:9002/",test:"http://testapi.zufangzi.com/",prod:"//api.zufangzi.com/"}[a],ke_ershouApi:{dev:"http://10.30.129.109:8058/",test:"http://test-i.bk-house-api.ke.com/",prod:"//bk-house-api.ke.com/"}[a]}}(),_util={noop:function(){},pad:function(e){return("0"+e).slice(-2)},httpHtml:function(e){return/ke.com|lianjia.com|realsee.com/.test(e)?e.replace(/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|&|-)+)/g,'<a href="$1$2" target="_blank">$1$2</a>'):e},timeFormat:function(e,t,a){var i=new Date(e),n=i.getFullYear()+"",o=this.pad(i.getMonth()+1),s=this.pad(i.getDate()),r=this.pad(i.getHours()),d=this.pad(i.getMinutes()),c=this.pad(i.getSeconds()),l="";switch(t){case"deltaTime":var u=new Date;l=i.getFullYear()===u.getFullYear()&&i.getMonth()===u.getMonth()&&i.getDate()===u.getDate()?r+":"+d:u.getTime()-i.getTime()<864e5?"昨天 "+r+":"+d:a.replace(/YYYY/g,n).replace(/MM/g,o).replace(/DD/g,s).replace(/hh/g,r).replace(/mm/g,d).replace(/ss/g,c);break;default:l=t.replace(/YYYY/g,n).replace(/MM/g,o).replace(/DD/g,s).replace(/hh/g,r).replace(/mm/g,d).replace(/ss/g,c)}return l},getCookie:function(e){if(0<document.cookie.length){var t=document.cookie.indexOf(e+"="),a=0;if(-1!=t)return t=t+e.length+1,-1==(a=document.cookie.indexOf(";",t))&&(a=document.cookie.length),decodeURI(document.cookie.substring(t,a))}return""},setCookie:function(e,t,a){var i=new Date;i.setDate(i.getDate()+a),document.cookie=e+"="+encodeURI(t)+(null==a?"":";expires="+i.toUTCString())},apiUrl:function(e){return apiRoot.ljApi+e},xinfangUrl:function(e){return apiRoot.xfApi+e},zulinUrl:function(e){return apiRoot.zulinApi+e},ke_ershouUrl:function(e){return apiRoot.ke_ershouApi+e},imApiUrl:function(e){return apiRoot.imApi.msg+e}},Tr;function LianjiaIM(i,e){var l=this;if(!i.appid||!i.appkey)throw new Error("IM Error: need appkey & appid to init lianjia IM.");var t=-1<window.location.href.indexOf("ke");this.login=i.login,this.token=i.token,this.is_ljbb=i.is_ljbb,this.is_bkbb=i.is_bkbb,this.is_accuse="",this.accuseType=0,this.downAppUrl=i.downAppUrl||(t?"//www.ke.com/client/":"//www.lianjia.com/client/"),this.appDesc=i.appDesc||(t?"立即下载贝壳找房APP, 随时随地聊~":"立即下载链家APP，随时随地聊~"),this.unreadSum=0,this.notify=i.notify||!1,this.version=i.version||1.1,this.validUrl=/^https?:\/\/(([a-zA-Z0-9_-])+(\.)?)*(ke.com|lianjia.com|realsee.com|ljcdn.com)/,this.header={"Lianjia-Im-Protocal-Version":"1.1","Lianjia-App-Id":i.appid,"Lianjia-Access-Token":i.token||"1","Lianjia-Device-Id":_util.getCookie("lianjia_uuid")},localStorage.setItem("BangInfo","{}"),this.userData=$.extend({uuid:_util.getCookie("lianjia_uuid"),cityid:_util.getCookie("select_city")},i.userData||{}),this.userData.code||(l.userData=$.extend({ucid:_util.getCookie("lianjia_uuid"),name:"游客",avatar:"",type:1},l.userData)),l.BangInfo=JSON.parse(localStorage.getItem("BangInfo")||"{}"),l.BangInfoNow=l.BangInfo[l.userData.ucid]||{},l.bangData=$.extend({},{conv_id:"",callUuid:"",skillCode:""},l.BangInfoNow),$(window).on("storage",function(e){"BangInfo"==e.originalEvent.key&&(l.BangInfo=JSON.parse(localStorage.getItem("BangInfo")||"{}"),l.BangInfoNow=l.BangInfo[l.userData.ucid]||{},l.bangData=$.extend({},{conv_id:"",callUuid:"",skillCode:""},l.BangInfoNow))}),this.updateBangInfo=function(){this.BangInfo[this.userData.ucid]=$.extend({},this.BangInfoNow),localStorage.setItem("BangInfo",JSON.stringify(this.BangInfo))},this.bangMsgList={},this.visibleBang=!1,this.isFirstInline=!0,this.pageConf=i,this.firstInitMessageList=!0,this.imgRoot="https://s1.ljcdn.com/web-im-sdk",this.staticRoot=i.staticRoot.replace(/\/\?_v=\d*/g,""),this.is_ljbb||this.is_bkbb?this.rootnode=$(['<div class="lianjiaim im-fold" data-role="lianjiaim">','<div class="lianjiaim-shandow clear">','<div class="lianjiaim-wrap" data-role="im-wrap">','<div class="lianjiaim-head" data-role="im-head">','<span data-role="im-title">在线咨询</span>','<span class="lianjiaim-head-num" data-role="im-unread" data-unread="0" style="display: none;">0</span>','<a class="lianjiaim-head-closebtn" title="收起" data-role="im-foldbtn">收起</a>',"</div>",'<div class="lianjiaim-body" data-role="im-body">','<ul class="lianjiaim-service" data-role="im-serviceitem-container">','<li class="lianjiaim-body-item">','<div class="im-item-show clear">',"<table>","<tbody>","<tr>",'<td class="im-item-avatar">','<img src="'+this.staticRoot+"/pc/asset/lianjiaIM/img/imgV2/"+(this.is_bkbb?"icon_online@2x.png":"icon_serv@2xV2.png")+'" alt="" width="40" height="40" data-role="im-listitem-item-avatar">','<i data-role="im-listitem-item-newmsg" style="display: none;" data-newmsg="0">0</i>',"</td>",'<td class="im-item-cont">','<span class="name" data-role="im-listitem-item-name"></span>','<span class="text" data-role="im-listitem-item-text"></span>',"</td>","</tr>","</tbody>","</table>","</div>","</li>","</ul>",'<ul data-role="im-listitem-container" style="display: none;"></ul>','<div class="lianjiaim-noagent" data-role="im-noagent-container" style="">','<div class="noagent-title">没有聊过的经纪人</div>',"</div>","</div>","</div>",'<div class="lianjiaim-window im-online" data-role="im-window" data-agentid="" style="display: none;">','<div class="lianjiaim-wintitle">',"<i>在线</i>",'<span class="im-wt-name" data-role="im-window-name"></span>','<a class="im-wt-closebtn" title="关闭" data-role="im-window-closebtn">关闭</a>',"</div>",'<div class="lianjiaim-wincont">','<div class="im-wc-hint"><span data-role="im-window-offlinename"></span>当前不在线，您可以在线留言</div>','<div class="im-wc-chat" data-role="im-window-chatcontainer">','<p class="chat-tophint">聊天的时候，经纪人无法知道您的手机号！</p>','<div data-role="im-logtrigger"></div>','<ul data-role="im-window-msgcontainer"></ul>',"</div>",'<div class="im-wc-input">','<div class="im-input-container" data-role="im-input-container">','<textarea placeholder="点击输入您想要咨询的问题…" data-role="im-input-textarea"></textarea>','<a class="im-input-insertpic" title="插入图片" data-role="im-input-picbtn">插入图片</a>','<input type="file" style="display: none;" accept=".gif,.jpg,.jpeg,.png,.bmp" data-role="im-input-picupload"/>','<span class="im-errorlog" data-role="im-errorlog" style="display: none;"></span>',"</div>",'<div class="im-btn-container">','<a href="'+this.downAppUrl+'" target="_blank" title="下载链家APP">'+this.appDesc+"</a>",'<input type="button" value="发送" class="send" data-role="im-input-sendbtn"/>',"</div>","</div>","</div>","</div>",'<div class="lianjiaim-window im-online" data-role="im-bang" style="display: none;">','<div class="lianjiaim-wintitle">',"<i>在线</i>",'<span class="im-wt-name">链家帮帮</span>','<span class="im-wt-time">在线人工服务时间：9:00 - 22:00</span>','<a class="im-wt-closebtn" title="关闭" data-role="bang-close">关闭</a>',"</div>",'<div class="lianjiaim-wincont">','<div class="im-wc-chat bang-chatcontainer" data-role="bang-chatcontainer">','<ul data-role="bang-msgcontainer"></ul>',"</div>",'<div class="im-wc-input">','<div class="im-input-container" data-role="im-input-container">','<textarea placeholder="点击输入您想要咨询的问题…" data-role="bang-textarea"></textarea>','<a class="im-input-insertpic" title="插入图片" data-role="bang-picbtn">插入图片</a>','<input type="file" style="display: none;" accept=".gif,.jpg,.jpeg,.png,.bmp" data-role="bang-picupload"/>',"</div>",'<div class="im-btn-container">','<input type="button" value="发送" class="send" data-role="bang-send"/>','<input type="button" value="结束对话" class="end" data-role="bang-end" style="display: none;"/>',"</div>","</div>","</div>","</div>","</div>",'<div class="lianjiaim-personcard" data-role="im-pcard" style="display: none; top: 9999em; left: 9999em;">','<div class="im-personcard-top clear">','<div class="im-personcard-avatar">','<img src="" alt="" width="78" height="78" data-role="im-pcard-avatar"/>',"</div>",'<div class="im-personcard-detail">','<div class="im-personname-wrap">','<span class="im-personname" data-role="im-pcard-name"></span>','<span class="im-gray" data-role="im-pcard-grade"></span>',"</div>","<div>",'<span class="im-gray">主营商圈：</span>','<span data-role="im-pcard-district"></span>',"</div>","<div>",'<span class="im-gray">所属门店：</span>','<span data-role="im-pcard-store"></span>',"</div>","<div>",'<span class="im-gray">从业年限：</span>','<span data-role="im-pcard-workage"></span>',"</div>","</div>","</div>",'<div class="im-personcard-bottom">',"<table>","<tbody>","<tr>","<td>","<span>累计成交：</span>",'<span class="im-red" data-role="im-pcard-totaldeal"></span>',"</td>","<td>","<span>月总带看：</span>",'<span class="im-red" data-role="im-pcard-monthshow"></span>',"</td>","<td>","<span>好评率：</span>",'<span class="im-red" data-role="im-pcard-praiserate"></span>',"</td>","</tr>","</tbody>","</table>","</div>",'<a class="im-personcard-shopbtn" href="" target="_blank" title="进入店铺" data-role="im-pcard-shoplink">进入店铺</a>',"</div>","</div>"].join("")):this.rootnode=$(['<div class="lianjiaim im-fold" data-role="lianjiaim">','<div class="cover" style="position: fixed; height: 100%; width: 100%; background: #000; opacity: 0.6; z-index: 1001; display: none;"></div>','<div class="lianjiaim-shandow clear">','<div class="modal-wrap" style="border: 1px solid #ddd; width: 320px; height: 190px; border-radius: 4px; top: 137px; left: 164px; position: absolute; z-index: 1002; background: white; display: none;">','<div class="close-modal" style="color: #9297A6; position: absolute; top: 10px; right: 10px; font-size: 16px; cursor: pointer">&times;</div>','<div class="set-accuse" style="display: none;">','<div style="margin: 40px 32px 27px; font-size: 16px; font-weight: bold;">举报后，该用户将无法与您收发消息</div>','<div style="margin-left: 32px;">','<label style="margin-right: 44px; cursor: pointer" for="WEISHANG"><input name="type" type="radio" id="WEISHANG" value="WEISHANG" />  微商</label>','<label style="margin-right: 44px; cursor: pointer" for="TONGYE"><input name="type" type="radio" id="TONGYE" value="TONGYE" />  同业</label>','<label for="SAORAO" style="cursor: pointer"><input name="type" type="radio" id="SAORAO" value="SAORAO" />  骚扰</label>',"</div>","</div>",'<div class="cancel-accuse" style="display:none;">','<div style="margin: 40px 32px 70px 60px; font-size: 16px; font-weight: bold;">是否确认取消举报该用户？</div>',"</div>",'<div style="margin-top: 30px; text-align: center"><button  style="width: 80px; height: 32px; background: #0984F9; color: #fff; font-size: 14px; cursor: pointer;" id="confirm-accuse">确定</button></div>',"</div>",'<div class="lianjiaim-wrap" data-role="im-wrap">','<div class="lianjiaim-head" data-role="im-head">','<span data-role="im-title">在线咨询</span>','<span class="lianjiaim-head-num" data-role="im-unread" data-unread="0" style="display: none;">0</span>','<a class="lianjiaim-head-closebtn" title="收起" data-role="im-foldbtn">收起</a>',"</div>",'<div class="lianjiaim-body" data-role="im-body">','<ul data-role="im-listitem-container" style="display: none;"></ul>','<div class="lianjiaim-noagent" data-role="im-noagent-container" style="">','<div class="noagent-title">没有聊过的经纪人</div>',"</div>","</div>","</div>",'<div class="lianjiaim-window im-online" data-role="im-window" data-agentid="" style="display: none;">','<div class="lianjiaim-wintitle">',"<i>在线</i>",'<span class="im-wt-name" data-role="im-window-name"></span>','<a class="im-wt-closebtn" title="关闭" data-role="im-window-closebtn">关闭</a>',"</div>",'<div class="lianjiaim-wincont">','<div class="im-wc-hint"><span data-role="im-window-offlinename"></span>当前不在线，您可以在线留言</div>','<div class="im-wc-chat" data-role="im-window-chatcontainer">','<div class="report-celling" style="display: none; position: fixed; width: 380px; z-index: 5; padding: 10px 40px; background: #FFFBE6; line-height: 22px; font-size: 12px;color: rgba(0,0,0,0.65);">','<img style="height: 14px; width: 14px; margin: 5px 5px 6px auto;" src="'+this.imgRoot+'/static/notify2@2x.png"/>','<span class="report-text"></span>',"</div>",'<p class="chat-tophint">聊天的时候，经纪人无法知道您的手机号！</p>','<div data-role="im-logtrigger"></div>','<ul data-role="im-window-msgcontainer"></ul>',"</div>",'<div class="im-wc-input">','<div class="im-input-container" data-role="im-input-container">','<textarea placeholder="点击输入您想要咨询的问题…" data-role="im-input-textarea"></textarea>','<a class="im-input-insertpic" title="插入图片" data-role="im-input-picbtn">插入图片</a>','<input type="file" style="display: none;" accept=".gif,.jpg,.jpeg,.png,.bmp" data-role="im-input-picupload"/>','<span class="im-errorlog" data-role="im-errorlog" style="display: none;"></span>',"</div>",'<div class="im-btn-container">','<span class="is_accuse" style="display: inline-block; cursor: pointer; color: #C7C7C7; font-size: 12px; line-height: 14px; margin-top: 4px;">','<img style="height: 14px; width: 14px; margin: 0px 2px 2px auto;" src="'+this.imgRoot+'/static/alarm@2x.png"/>','<span class="accuse-text">举报</span>',"</span>",'<a href="'+this.downAppUrl+'" target="_blank" title="下载APP">'+this.appDesc+"</a>",'<input type="button" value="发送" class="send" data-role="im-input-sendbtn"/>',"</div>","</div>","</div>","</div>",'<div class="lianjiaim-window im-online" data-role="im-bang" style="display: none;">','<div class="lianjiaim-wintitle">',"<i>在线</i>",'<span class="im-wt-name">链家帮帮</span>','<span class="im-wt-time">在线人工服务时间：9:00 - 22:00</span>','<a class="im-wt-closebtn" title="关闭" data-role="bang-close">关闭</a>',"</div>",'<div class="lianjiaim-wincont">','<div class="im-wc-chat bang-chatcontainer" data-role="bang-chatcontainer">','<ul data-role="bang-msgcontainer"></ul>',"</div>",'<div class="im-wc-input">','<div class="im-input-container" data-role="im-input-container">','<textarea placeholder="点击输入您想要咨询的问题…" data-role="bang-textarea"></textarea>','<a class="im-input-insertpic" title="插入图片" data-role="bang-picbtn">插入图片</a>','<input type="file" style="display: none;" accept=".gif,.jpg,.jpeg,.png,.bmp" data-role="bang-picupload"/>',"</div>",'<div class="im-btn-container">','<input type="button" value="发送" class="send" data-role="bang-send"/>','<input type="button" value="结束对话" class="end" data-role="bang-end" style="display: none;"/>',"</div>","</div>","</div>","</div>","</div>",'<div class="lianjiaim-personcard" data-role="im-pcard" style="display: none; top: 9999em; left: 9999em;">','<div class="im-personcard-top clear">','<div class="im-personcard-avatar">','<img src="" alt="" width="78" height="78" data-role="im-pcard-avatar"/>',"</div>",'<div class="im-personcard-detail">','<div class="im-personname-wrap">','<span class="im-personname" data-role="im-pcard-name"></span>','<span class="im-gray" data-role="im-pcard-grade"></span>',"</div>","<div>",'<span class="im-gray">主营商圈：</span>','<span data-role="im-pcard-district"></span>',"</div>","<div>",'<span class="im-gray">所属门店：</span>','<span data-role="im-pcard-store"></span>',"</div>","<div>",'<span class="im-gray">从业年限：</span>','<span data-role="im-pcard-workage"></span>',"</div>","</div>","</div>",'<div class="im-personcard-bottom">',"<table>","<tbody>","<tr>","<td>","<span>累计成交：</span>",'<span class="im-red" data-role="im-pcard-totaldeal"></span>',"</td>","<td>","<span>月总带看：</span>",'<span class="im-red" data-role="im-pcard-monthshow"></span>',"</td>","<td>","<span>好评率：</span>",'<span class="im-red" data-role="im-pcard-praiserate"></span>',"</td>","</tr>","</tbody>","</table>","</div>",'<a class="im-personcard-shopbtn" href="" target="_blank" title="进入店铺" data-role="im-pcard-shoplink">进入店铺</a>',"</div>","</div>"].join("")),this.nodes={wrap:this.rootnode.find('[data-role="im-wrap"]'),head:this.rootnode.find('[data-role="im-head"]'),title:this.rootnode.find('[data-role="im-title"]'),body:this.rootnode.find('[data-role="im-body"]'),serviceItemContainer:this.rootnode.find('[data-role="im-serviceitem-container"]'),listItemContainer:this.rootnode.find('[data-role="im-listitem-container"]'),noagentContainer:this.rootnode.find('[data-role="im-noagent-container"]'),headUnread:this.rootnode.find('[data-role="im-unread"]'),foldBtn:this.rootnode.find('[data-role="im-foldbtn"]'),talkwindow:this.rootnode.find('[data-role="im-window"]'),talkwindowOfflineName:this.rootnode.find('[data-role="im-window-offlinename"]'),talkwindowChatContainer:this.rootnode.find('[data-role="im-window-chatcontainer"]'),talkwindowMsgContainer:this.rootnode.find('[data-role="im-window-msgcontainer"]'),inputContainer:this.rootnode.find('[data-role="im-input-container"]'),inputTextarea:this.rootnode.find('[data-role="im-input-textarea"]'),inputPicBtn:this.rootnode.find('[data-role="im-input-picbtn"]'),inputPicUpload:this.rootnode.find('[data-role="im-input-picupload"]'),inputSendBtn:this.rootnode.find('[data-role="im-input-sendbtn"]'),errorlogContainer:this.rootnode.find('[data-role="im-errorlog"]'),pcard:this.rootnode.find('[data-role="im-pcard"]'),logTrigger:this.rootnode.find('[data-role="im-logtrigger"]'),topText:this.rootnode.find("p.chat-tophint"),bbtitle:this.rootnode.find('[data-role="im-listitem-item-name"]'),bbsubtitle:this.rootnode.find('[data-role="im-listitem-item-text"]'),bbname:this.rootnode.find("span.im-wt-name"),bbtime:this.rootnode.find(".im-wt-time"),talkBang:this.rootnode.find('[data-role="im-bang"]'),talkBangMsgContainer:this.rootnode.find('[data-role="bang-msgcontainer"]'),talkBangTextarea:this.rootnode.find('[data-role="bang-textarea"]'),picBtnBang:this.rootnode.find('[data-role="bang-picbtn"]'),picInputBang:this.rootnode.find('[data-role="bang-picupload"]'),talkBangDownload:this.rootnode.find('[data-role="bang-download"]'),talkBangSend:this.rootnode.find('[data-role="bang-send"]'),talkBangEnd:this.rootnode.find('[data-role="bang-end"]'),is_accuse:this.rootnode.find("span.is_accuse"),accuseModal:this.rootnode.find("div.modal-wrap"),closeModal:this.rootnode.find("div.modal-wrap div.close-modal"),cancleAccuse:this.rootnode.find("div.modal-wrap div.cancle-accuse"),setAccuse:this.rootnode.find("div.modal-wrap div.set-accuse"),cancelAccuse:this.rootnode.find("div.modal-wrap div.cancel-accuse"),cover:this.rootnode.find("div.cover"),accuseType:this.rootnode.find('div.modal-wrap input[name="type"]'),confirm:this.rootnode.find("#confirm-accuse"),reportCelling:this.rootnode.find("div.lianjiaim-wincont .report-celling"),accuseText:this.rootnode.find("div.im-btn-container span.accuse-text"),reportText:this.rootnode.find("span.report-text")},this.nodes.bbtitle.text(this.is_bkbb?"在线客服":"链家帮帮"),this.nodes.bbsubtitle.text(this.is_bkbb?"贝壳找房官方人工客服":"链家网官方人工客服"),this.nodes.bbname.text(this.is_bkbb?"在线客服":"链家帮帮"),this.nodes.bbtime.text("在线人工服务时间：9:00 - 22:00"),this.listItemTemplate=$.template(['<li class="lianjiaim-body-item<% if (!item.user_status) { %> offline<% } %>" data-role="im-listitem-item" data-convid="<%= item.convId %>" data-convtype="<%= item.convType %>" data-agentid="<%= item.id %>" data-msgtime="0">','<div class="im-item-show clear">',"<table>","<tbody>","<tr>",'<td class="im-item-avatar">','<img src="<%= item.avatar %>" alt="" width="40" height="40" data-role="im-listitem-item-avatar"/>','<i data-role="im-listitem-item-newmsg" style="display: none;" data-newmsg="0">0</i>',"</td>",'<td class="im-item-cont">','<span class="name" title="" data-role="im-listitem-item-name"><%= item.name %></span>','<span class="text" title="" data-role="im-listitem-item-text"><%= item.summary %></span>',"</td>","</tr>","</tbody>","</table>",'<div class="im-item-time" data-role="im-listitem-item-time"></div>','<a class="im-item-delbtn" title="删除" data-role="im-listdelbtn">&#215;</a>',"</div>",'<div class="im-item-delete clear">',"<div>",'<span class="title">确定删除？</span>','<span class="cont">删除后将不可恢复</span>',"</div>",'<div class="im-item-delbtnwrap">','<a class="im-btn" title="确定" data-role="im-listdel-confirmbtn">确定</a>','<a class="im-btn" title="取消" data-role="im-listdel-cancelbtn">取消</a>',"</div>","</div>","</li>"].join("")),this.messageNodeTemplate=$.template(['<li class="chat-block clear <%= sendType %>" data-msgtime="<%= timestamp %>" data-msgid="<%= msgid %>" data-role="msgitem">','<div class="chat-avatar">','<a title="<%= user.username %>" data-role="im-window-avatar"><img src="<%= user.avatar %>" alt="<%= user.username %>" width="34" height="34"/></a>',"</div>",'<div class="chat-content">',"<i>&#9660;</i>","<div><%= message.text %></div>","</div>","</li>"].join("")),this.picNodeTemplate=$.template(['<li class="chat-block clear <%= sendType %>" data-msgtime="<%= timestamp %>" data-msgid="<%= msgid %>" data-role="msgitem">','<div class="chat-avatar">','<a title="<%= user.username %>" data-role="im-window-avatar"><img src="<%= user.avatar %>" alt="<%= user.username %>" width="34" height="34"/></a>',"</div>",'<div class="chat-content">',"<i>&#9660;</i>",'<p><a href="<%= pic.url %>" title="<%= pic.desc %>" target="_blank"><img class="chat-msg-pic" src="<%= pic.thumb %>" alt="<%= pic.desc %>" /></a></p>',"</div>","</li>"].join("")),this.housecardNodeTemplate=$.template(['<li class="chat-block clear <%= sendType %>" data-msgtime="<%= timestamp %>" data-msgid="<%= msgid %>" data-role="msgitem">','<div class="chat-avatar">','<a title="<%= user.username %>" data-role="im-window-avatar"><img src="<%= user.avatar %>" alt="<%= user.username %>" width="34" height="34"/></a>',"</div>",'<div class="chat-content">',"<i>&#9660;</i>",'<a class="im-housecard" href="<%= houseinfo.schemeUrl %>" target="_blank" title="<%= houseinfo.houseName %>">','<img src="<%= houseinfo.houseImgUrl %>" alt="<%= houseinfo.houseName %>" width="54" height="54"/>','<span class="im-housecard-detail">','<span class="im-housecard-title"><%= houseinfo.houseName %></span>','<span class="im-housecard-describe"><em><%= houseinfo.houseBedroomCount %>室<%= houseinfo.houseHallCount %>厅</em><em><%= houseinfo.area %>㎡</em><em><%= houseinfo.orientation %></em></span>','<span style="display: flex; justify-content: space-between" class="im-housecard-price"><%= (houseinfo.price / 10000) + houseinfo.priceUnit %><span style="text-align:right; font-weight:bold"><%= houseinfo.houseState==2 ? "成交" : "" %></span></span>',"</span>","</a>","</div>","</li>"].join("")),this.chatTimeNodeTemplate=$.template(['<li class="chat-time"><%= time %></li>'].join("")),this.xinfangcardNodeTemplate=$.template(['<li class="chat-block clear <%= sendType %>" data-msgtime="<%= timestamp %>" data-msgid="<%= msgid %>" data-role="msgitem">','<div class="chat-avatar">','<a title="<%= user.username %>" data-role="im-window-avatar"><img src="<%= user.avatar %>" alt="<%= user.username %>" width="34" height="34"/></a>',"</div>",'<div class="chat-content">',"<i>&#9660;</i>",'<a class="im-housecard" href="<%= houseinfo.schemeUrl %>" target="_blank" title="<%= houseinfo.houseName %>">','<img src="<%= houseinfo.buildingImgUrl %>" alt="<%= houseinfo.buildingName %>" width="54" height="54"/>','<span class="im-housecard-detail">','<span class="im-housecard-title"><%= houseinfo.buildingName %></span>','<span class="im-housecard-describe"><em><%= houseinfo.area %></em><em class="im-house-type-right"><%= houseinfo.houseType %></em></span>','<span class="im-housecard-price"><%= houseinfo.avgPrice %></span>',"</span>","</a>","</div>","</li>"].join("")),this.zulincardNodeTemplate=$.template(['<li class="chat-block clear <%= sendType %>" data-msgtime="<%= timestamp %>" data-msgid="<%= msgid %>" data-role="msgitem">','<div class="chat-avatar">','<a title="<%= user.username %>" data-role="im-window-avatar"><img src="<%= user.avatar %>" alt="<%= user.username %>" width="34" height="34"/></a>',"</div>",'<div class="chat-content">',"<i>&#9660;</i>",'<a class="im-housecard" href="<%= houseinfo.schemeUrl %>" target="_blank" title="<%= houseinfo.houseName %>">','<img src="<%= houseinfo.buildingImgUrl %>.54x54.jpg" alt="<%= houseinfo.buildingName %>" width="54" height="54"/>','<span class="im-housecard-detail">','<span class="im-housecard-title"><%= houseinfo.buildingName %></span>','<span class="im-housecard-describe"><em><%= houseinfo.area %></em><em class="im-house-type-right"><%= houseinfo.houseType %></em></span>','<span class="im-housecard-price"><%= houseinfo.avgPrice %></span>',"</span>","</a>","</div>","</li>"].join("")),this.msg330NodeTemplate=$.template(['<li class="chat-block card330 clear <%= sendType %> <%= msgid %>" data-role="msgitem" style="margin-bottom:35px;">','<div class="chat-avatar">','<a title="<%= user.username %>" data-role="im-window-avatar"><img src="<%= user.avatar %>" alt="<%= user.username %>" width="34" height="34"/></a>',"</div>",'<div class="chat-content type-3" style="background: white; padding: 0px; border-radius: 10px; overflow: hidden; height: 180px; width:200px">','<a class="house-card" href="javascript:;" target="_blank">','<span class="im-housecard-detail" style="margin: 0px; height: auto; width: 200px;">','<span class="im-housecard-img" style="width:200px"></span>','<span class="im-housecard-title" style="margin-left: 15px"></span>','<span class="im-housecard-info" style="margin-left: 15px"></span>','<span class="im-housecard-price" style="margin-left: 15px"></span>',"</span>","</a>","</div>",'<div class="chat-content type-cardId1" style="background: white; padding: 0px; border-radius: 10px; overflow: hidden; width:254px">','<div class="im-phonecard-detail" style="margin: auto 15px; height: auto;">','<div class="im-phonecard-title"','style="margin-top: 11px;font-family: PingFang-SC-Bold;font-weight: bold;font-size: 16px;color: #394043;letter-spacing: 0;line-height: 21px">',"</div>",'<div class="im-phonecard-desc" ','style="margin-bottom: 14px;margin-top: 8px;font-family: PingFangSC-Regular;font-size: 15px;color: #394043;letter-spacing: 0;line-height: 19px;">',"</div>",'<div class="im-phonecard-btns" style="display: flex;text-align: center;margin: 8px 0;border-top: 1px solid #E6E6E6">','<span class="im-phonecard-btn im-phonecard-btn1" style="flex:1;margin: 8px 0;"></span>','<span class="im-phonecard-btn im-phonecard-btn2" style="flex:1;margin: 8px 0;border-left: 1px solid #E5E5E5"></span>',"</div>","</div>","</div>",'<div class="chat-content type-1" style="padding: 10px; border-radius: 10px; overflow: hidden; width:200px">','<p class="im-housecard-info" style="font-size: 14px">暂不支持该消息类型，请前往app查看</p>',"</div>",'<div style="position: relative;" class="type-3-label">','<span class="im-housecard-label" style="position: absolute; right: 220px; top: 185px; font-size: 12px; display: inline-block; padding: 2px 5px; border: 1px solid #ddd; border-radius: 5px; background: #bab9b9; color: #fff;"></span>',"</div>","</li>"].join("")),this.msg802NodeTemplate=$.template(['<li class="chat-system-msg" style="padding: 0 10px;color: #aaa;font-size: 12px;text-align: center;margin-bottom: 10px;" data-msgid="<%= msgid %>"><%= desc %></li>'].join("")),this.msgRecallTemplate=$.template(['<li class="msgRecall clear" data-msgid="<%= msgid %>" >','<div class="chat-msg-recall" data-msgid="<%= msgid %>" >撤回</div>',"</li>"].join("")),this.bangShowEnd=function(e){e?(l.nodes.talkBangDownload.hide(),l.nodes.talkBangEnd.show()):(l.nodes.talkBangDownload.show(),l.nodes.talkBangEnd.hide()),l.scrollBangWindow("bottom")},this.bangRenderSysMsg=function(e,t){var a=$.template(['<li class="chat-wait">'+e+"</li>"].join("")).render();if(t)return a;l.nodes.talkBangMsgContainer.append(a),l.scrollBangWindow("bottom")},this.bangRenderMsg=function(e,t,a,i,n){var o=t?"chat-out":"chat-in";e=(e=n?e:_util.httpHtml(e)).replace(/(\/\:\S*\s)/g,function(e){for(var t in e=$.trim(e),sticker)if(e==sticker[t].code)return'<img style="height: 20px;" src="'+l.staticRoot+"/pc/asset/lianjiaIM/img/sticker/"+sticker[t].face+'.gif"/>';return e});var s=l.messageNodeTemplate.render({sendType:[o,a||""].join(" "),timestamp:$.now(),msgid:"0",user:{username:t?this.userData.username||"游客":l.is_bkbb?"在线客服":"链家帮帮",avatar:t?this.userData.avatar||l.staticRoot+"/pc/asset/lianjiaIM/img/imgV2/tourist.png":l.staticRoot+"/pc/asset/lianjiaIM/img/imgV2/"+(l.is_bkbb?"icon_online@2x.png":"icon_serv@2xV2.png")},message:{text:e}});if(i)return s;l.nodes.talkBangMsgContainer.append(s),l.scrollBangWindow("bottom")},this.bangRenderHistory=function(e){if(e.length){var r=[];e.forEach(function(e,t){var a="",i=!1,n="SN_LJBB"!=e.fromUcid&&"KE_KEFU"!=e.fromUcid,o=_util.timeFormat(e.sendTime,"deltaTime","YYYY-MM-DD hh:mm");if(-1==e.type&&(a=l.bangRenderMsg(e.payload,n,"",!0),i=!0),99!=e.type||n||(a=l.bangRenderMsg(JSON.parse(e.payload).url,!1,"",!0),i=!0),600==e.type||-2==e.type)try{var s=JSON.parse(e.payload);s.original&&(a=l.bangRenderPic(s,n,!0),i=!0),s.desc&&(a=l.bangRenderSysMsg(s.desc,!0),"object"==typeof s.content&&s.content.message&&(a=l.bangRenderSysMsg(s.content.message,!0),2==s.type&&1==s.content.sessionStatus&&(a=l.bangRenderMsg(s.content.message,!1,"",!0))),i=!0)}catch(e){}i&&r.push(l.bangRenderSysMsg(o,!0)),r.push(a)}),l.nodes.talkBangMsgContainer.prepend(r.join("")),l.scrollBangWindow("bottom")}},this.bangRenderPic=function(e,t,a){var i="图片",n=e.thumbnail,o=e.original;this.validUrl.test(payload.thumbnail)||(e.thumbnail=null,i="非法图片"),this.validUrl.test(e.original)||(e.original=null,i="非法图片");var s=['<a href="'+e.original+'" title='+i+' target="_blank" data-invalid='+o+">",'<img class="chat-msg-pic" src="'+e.thumbnail+'" alt='+i+" data-invalid="+n+"/>","</a>"].join("");if(a)return this.bangRenderMsg(s,t,"",!0,!0);this.bangRenderMsg(s,t,"",!1,!0)},this.bangRenderType=function(){var e=this.is_bkbb?["<div>","<p>您好，在线客服很高兴为您服务，请选择您咨询的服务类型</p>",'<div class="bang-type">',[{text:"贝壳二手房",value:"BEIKESECOND"},{text:"贝壳新房",value:"BEIKENEWHOUSE"},{text:"贝壳房屋租赁",value:"BEIKELEASE"}].map(function(e,t){return'<span data-role="bang-type" data-value="'+e.value+'">'+e.text+"</span>"}).join(""),"</div>","</div>"]:["<div>","<p>您好，链家帮帮很高兴为您服务，请选择您咨询的服务类型</p>",'<div class="bang-type">',[{text:"二手房",value:"JNZ001"},{text:"新房",value:"JNZ002"},{text:"房屋租赁",value:"JNZ003"}].map(function(e,t){return'<span data-role="bang-type" data-value="'+e.value+'">'+e.text+"</span>"}).join(""),"</div>","</div>"];e=e.join(""),this.bangRenderMsg(e,!1,"chat-bang")},this.bangRenderAppraise=function(){var e=['<div class="bang-appraise">','<div class="appraise-title">请您对我的服务做出评价，谢谢。</div>','<div class="appraise-type">',[{name:"reaction",text:"响应时效",value:5},{name:"solved",text:"问题解决",value:5},{name:"attitude",text:"服务态度",value:5}].map(function(e,t){return['<div class="appraise-type-item" data-name="'+e.name+'" data-value="'+e.value+'">','<div class="appraise-text">'+e.text+"</div>",'<div class="appraise-stars">',[1,1,1,1,1].map(function(){return'<span class="appraise-star active"></span>'}).join(""),"</div>",'<div class="appraise-num">5分</div>',"</div>"].join("")}).join(""),"</div>",'<textarea data-role="appraise-textarea" placeholder="请写下您的宝贵意见和建议..." maxlength="120"></textarea>','<div class="appraise-btns">','<span data-role="appraise-btn-cancel" class="appraise-btn-cancel">取消</span>','<span data-role="appraise-btn-submit" class="appraise-btn-submit">确定</span>',"</div>","</div>"].join("");l.bangRenderMsg(e,!1,"chat-bang")},this.scrollBangWindow=function(e){$(".bang-chatcontainer").scrollTop(function(){return $.isNumeric(e)?e:"top"===e?0:l.nodes.talkBangMsgContainer.height()-$(this).height()+100})},this.bangTalkDisable=function(e){l.scrollBangWindow("bottom")},this.bangInline=function(){l.bangRenderSysMsg("正在为您安排坐席，请稍等..."),l.core.sendTo(l.bangData.conv_id,{type:600,payload:JSON.stringify({type:1,content:{customerId:l.userData.ucid,customerName:l.userData.name,cityCode:l.userData.cityid,customerType:l.userData.code?2:1,skillCode:l.bangData.skillCode}})},function(e){if(!e)return l.bangRenderSysMsg("进线失败"),void l.bangTalkDisable(!0);l.bangShowEnd(!0)})},this.bangHangup=function(e,t){l.BangInfoNow={conv_id:l.BangInfoNow.conv_id},l.updateBangInfo(),l.core.sendTo(e,{type:600,payload:JSON.stringify({type:3,content:{hangupType:1}})},function(){t&&t()})},this.housecardReg=/(.*?)http[s]?:\/\/\S+?\.lianjia\.com.*?(ershoufang|chengjiao)\/(\S+?)\.html[#?=\-\w]*(.*)/i,this.xinfangcardReg=/(.*?)http[s]?:\/\/\S+?\.fang\.ke\.com\/loupan\/.*?(\S+?)[\/|?|#][#?=\-\w]*(.*)/i,this.zulincardReg=/(.*?)http[s]?:\/\/\S+?\.zu\.ke\.com\/zufang\/(\w+)\.html[\/|?|#]?[#?=\-\w]*(.*)/i,this.apartmentReg=/(.*?)http[s]?:\/\/\S+?\.zu\.ke\.com\/apartment\/(\w+)\.html[\/|?|#]?[#?=\-\w]*(.*)/i,this.ke_ershouCardReg=/(.*?)http[s]?:\/\/\S+?\.ke\.com\/ershoufang\/(\w+)\.html[\/|?|#]?[#?=\-\w]*(.*)/i,this.chengjiao_ershouCardReg=/(.*?)http[s]?:\/\/\S+?\.ke\.com\/chengjiao\/(\w+)\.html[\/|?|#]?[#?=\-\w]*(.*)/i,this.isFolding=!0,this.isLoadingHistory=!1,this.currentConvId="",this.lianjiaServiceWindow=null,this.errorlogTimer=0,this.publicAccount=["GUANG_XIAOXIA","GUANG_ZUYUE","GUANG_FANGYUANTIXING","GUANG_ZHUSHOU","NUOZHEN_ZUFANG","KE_ZHUANGXIUZHUSHOU","KE_XINXUANGUWEN"],this.publicAccounts=["NUOZHEN_ZUFANG","KE_ZHUANGXIUZHUSHOU","KE_XINXUANGUWEN"],this.msg2type={"-1":"文本","-2":"语音","-6":"文件",1:"房源卡片",2:"在线带看卡片",3:"如是看房卡片",7:"小区卡片",5:"看房日程卡片",6:"新房楼盘卡片 ",99:"链接卡片",8:"功能号消息",105:"自动回复",109:"GIF表情",211:"图集",310:"公开卡片",320:"私密卡片",330:"通用卡片",400:"公众号自定义菜单点击消息",120:"富文本消息",121:"新富文本消息",600:"帮帮（CRM）业务专用自定义消息",122:"群邀请卡片",123:"红包卡片",124:"角色化提示",125:"通用静态图文卡片消息",800:"进入会话",804:"智能助手提示消息"},this.imData={},this.agentData={},this.housecardStat={data:{},check:function(e,t){if(this.data[e]){var a=this.data[e][t]||0;return 6048e5<(new Date).getTime()-a}return!0},set:function(e,t){this.data[e]||(this.data[e]={}),this.data[e][t]=(new Date).getTime(),window.localStorage.housecardStat=JSON.stringify(this.data)}},this.housecardStat.data=JSON.parse(window.localStorage.housecardStat||"{}"),this.initMessageList=function(){l.core.on("message",function(e,t,o){var a={},i=[];$.each(t,function(e,t){a[t.convId]||(a[t.convId]=[]),a[t.convId].push(t)}),$.each(a,function(e,t){e=+e,i.push({convId:e,newMsgList:t})}),i.sort(function(e,t){return e.newMsgList.slice(-1)[0].sendTime-t.newMsgList.slice(-1)[0].sendTime}),$.each(i,function(){var i=this.convId,e=this.newMsgList;l.updateImDataConv(i,"convObj",l.core.convMap[i]),-1!==o&&l.imData[i].convObj.updateDetail(),null===l.imData[i].itemNode&&l.addConvItemNode(l.imData[i].convObj),$.each(e,function(e,t){l.imData[i].msgList.push(t)});var t=l.filterSupportMsg(e),a=t.slice(-1)[0]||{},n=0;i===l.currentConvId?(l.addMsg(t,"btm"),l.scrollWindow("btm")):-1!==o&&$.each(t,function(e,t){var a=l.imData[i].convObj;l.notify&&l.core.IMNotification({title:a.title,body:t.summary,icon:a.avatar},l.imgRoot),this.fromUcid!==l.userData.ucid&&n++}),l.updateConvItemNode(i,{text:l.getMsgSummary(a),time:a.sendTime,newmsgAmount:"+"+n},-1!==o)});var n=[],s=[],r=0;function d(e){var t={};"[object Array]"===Object.prototype.toString.call(e)&&(e=-1===e[0].type?(t=e[0]||{},e[1]):(t=e[1]||{},e[0]));try{var a=JSON.parse(e.payload),i="";2==a.type&&(i=a.content.message,1==a.content.sessionStatus&&(l.bangRenderSysMsg("进线成功"),l.bangRenderMsg(i)),2==a.content.sessionStatus&&l.bangRenderSysMsg(i),l.isFirstInline&&l.sendUrlBang(),l.bangData.callUuid=a.content.callUuid,l.BangInfoNow.callUuid=a.content.callUuid,l.updateBangInfo(),l.bangTalkDisable(!1),l.isFirstInline=!1),6==a.type&&(l.bangRenderSysMsg(a.content.message),l.bangTalkDisable(!0),4!=a.content.sessionStatus&&(l.BangInfoNow.skillCode="",l.updateBangInfo(),5!=a.content.sessionStatus&&l.bangRenderType()))}catch(e){}-1===t.type&&l.bangRenderMsg(t.payload)}if(-1==o){if(l.bangData.conv_id)2==t.length?d(t):n=t.filter(function(e,t){return e.convId==l.bangData.conv_id});else if(2==t.length)d(item);else{var c=t.filter(function(e){return"SN_LJBB"===e.fromUcid||"KE_KEFU"===e.fromUcid});c.length&&(n=t.filter(function(e,t){return e.convId==c[0].convId}))}l.bangRenderHistory(n)}else s=t.filter(function(e){return"SN_LJBB"===e.fromUcid||"KE_KEFU"===e.fromUcid}),r=+l.nodes.serviceItemContainer.find('[data-role="im-listitem-item-newmsg"]').attr("data-newmsg")+s.length,l.bangData.conv_id&&"none"===l.nodes.talkBang.css("display")?l.nodes.serviceItemContainer.find('[data-role="im-listitem-item-newmsg"]').attr("data-newmsg",r).text(r)[r?"show":"hide"]():l.nodes.serviceItemContainer.find('[data-role="im-listitem-item-newmsg"]').attr("data-newmsg",0).text(0).hide(),s.forEach(function(t){if(l.bangData.skillCode){if(l.bangMsgList[t.sendTime]==t.payload)return!1;if(l.bangMsgList[t.sendTime]=t.payload,t&&l.bangData.conv_id)try{var e=JSON.parse(t.payload),a="";"object"!=typeof e&&l.bangRenderMsg(e,!1),-2==t.type&&l.bangRenderPic(e,!1),99==t.type&&l.bangRenderMsg(e.url,!1,"",!1),2==e.type&&(a=e.content.message,1==e.content.sessionStatus&&(l.bangRenderSysMsg("进线成功"),l.bangRenderMsg(a)),2==e.content.sessionStatus&&l.bangRenderSysMsg(a),l.isFirstInline&&l.sendUrlBang(),l.bangData.callUuid=e.content.callUuid,l.BangInfoNow.callUuid=e.content.callUuid,l.updateBangInfo(),l.bangTalkDisable(!1),l.isFirstInline=!1),3==e.type&&(a=e.desc,l.bangTalkDisable(!0),l.bangRenderSysMsg("<span>"+a+'</span><span class="btn-handle" data-role="inline-again">重新进线</span>'),l.bangRenderAppraise(),l.BangInfoNow={conv_id:l.BangInfoNow.conv_id},l.updateBangInfo()),4==e.type&&3==e.content.sessionStatus&&(l.bangTalkDisable(!0),l.BangInfoNow={conv_id:l.BangInfoNow.conv_id},l.updateBangInfo(),l.bangRenderSysMsg('<span>会话已结束</span><span class="btn-handle" data-role="inline-again">重新进线</span>')),6==e.type&&(l.bangRenderSysMsg(e.content.message),l.bangTalkDisable(!0),4!=e.content.sessionStatus&&(l.BangInfoNow.skillCode="",l.updateBangInfo(),5!=e.content.sessionStatus&&l.bangRenderType())),7==e.type&&(5==e.content.status&&l.bangRenderSysMsg(e.content.message),6==e.content.status&&l.bangRenderSysMsg("<span>"+e.content.message+'</span><a class="btn-handle" target="_blank" href="http://cconline.netapi.lianjia.com/webchat/callback.html?lianjiaCity='+window.ljConf.city_id+'">预约呼叫</a>'),7==e.content.status&&l.bangRenderSysMsg(e.content.message))}catch(e){a=t.payload;l.bangRenderMsg(a,!1)}}});l.updateHeadUnread()}),l.core.on("arrive",function(e,t,a){var s=!1;t.map(function(e){var t=e.convId,a=e.fromUcid,i=JSON.parse(e.payload||"{}"),n=i.msg_id,o=i.time;t==l.currentConvId&&(s=!0),l.core.ucid!=a&&n&&(l.imData[t].arriveInfo?l.imData[t].arriveInfo.arrive<n&&(l.imData[t].arriveInfo={arrive:n,arriveTime:o}):l.imData[t].arriveInfo={arrive:n,arriveTime:o})}),l.updateArrive_Read({eventType:"msgArrive",isNeedUpdate:s,isFormOther:!0})}),l.core.on("read",function(e,t,a){var s=!1;t.map(function(e){var t=e.convId,a=e.fromUcid,i=JSON.parse(e.payload||"{}"),n=i.msg_id,o=i.time;t==l.currentConvId&&(s=!0),l.core.ucid!=a&&n&&(l.imData[t].readInfo?l.imData[t].readInfo.read<n&&(l.imData[t].readInfo={read:n,readTime:o}):l.imData[t].readInfo={read:n,readTime:o})}),l.updateArrive_Read({eventType:"msgRead",isNeedUpdate:s,isFormOther:!0})})},this.userData.code?(l.core=new ImCore({msgApiRoot:apiRoot.imApi.msg,mediaApiRoot:apiRoot.imApi.media,apiheader:l.header,appkey:i.appkey,ucid:l.userData.ucid}),this.getUcData(this.userData.ucid,function(e){var t=e[0]||{};l.userData=$.extend({ucid:t.uc_id,name:t.name,avatar:t.favicon,type:t.type},l.userData),l.core=new ImCore({msgApiRoot:apiRoot.imApi.msg,mediaApiRoot:apiRoot.imApi.media,apiheader:l.header,appkey:i.appkey,ucid:l.userData.ucid}),l.core.on("init",function(e){var a,t;$.each(l.core.convMap,function(e,t){e=+e,l.updateImDataConv(e,"convObj",t),l.updateImDataConv(e,"readMsgId",t.readMsgId)}),l.nodes.listItemContainer.on("click",'[data-role="im-listitem-item"]',function(){l.nodes.reportCelling.hide(),l.clickConvItemTrck();var e=$(this).attr("data-convid"),t=$(this).attr("data-agentid"),a=$(this).attr("data-convtype");"function"==typeof i.userTrack&&i.userTrack({event:"convClick",convId:e,agentId:t,convType:a}),l.currentConvId!==e&&(l.setWindow(e),l.showWindow(!0)),~l.publicAccount.indexOf(t)||l.core.fetchReportStatus(e,function(e){e&&(0<Object.keys(e.data).length?(l.accuseType=2,l.nodes.reportCelling.show(),l.nodes.reportText.html(e.data.desc),l.nodes.accuseText.html("取消举报")):(l.accuseType=1,l.nodes.reportCelling.hide(),l.nodes.accuseText.html("举报")))})}),l.nodes.talkwindow.on("click",'[data-role="im-window-closebtn"]',function(){l.currentConvId="",l.showWindow(!1)}),l.nodes.inputSendBtn.on("click",function(){""===l.currentConvId||l.nodes.inputSendBtn.prop("disabled")||(l.nodes.inputSendBtn.val("发送中...").prop({disabled:!0}),l.sendMsg(l.currentConvId,l.nodes.inputTextarea.val(),function(e,t){if(l.nodes.inputSendBtn.val("发送").prop({disabled:!1}),$.isEmptyObject(e)){var a="消息发送失败";42504===t.errno&&(a=t.error),l.showErrorlog(a)}else l.nodes.inputTextarea.val("")})),"function"==typeof i.userTrack&&i.userTrack({event:"clickSend",convId:l.currentConvId,content:l.nodes.inputTextarea.val()})}),l.nodes.inputTextarea.on("keydown",function(e){13===e.keyCode&&!1===e.ctrlKey&&(e.preventDefault(),l.nodes.inputSendBtn.trigger("click"))}),l.nodes.inputPicBtn.on("click",function(){l.nodes.inputPicUpload.trigger("click")}),l.nodes.inputPicUpload.on("change",function(e){l.sendPic(l.currentConvId,l.nodes.inputPicUpload[0].files[0],function(e){$.isEmptyObject(e)&&l.showErrorlog("图片发送失败")})}),l.nodes.talkwindowChatContainer.delegate(".chat-content","contextmenu",function(e){e.preventDefault(),e.stopPropagation(),$(".msgRecall").remove();for(var t=$(this).closest(".chat-block"),a=t.data("msgid"),i=l.imData[l.currentConvId].msgList,n=i.length,o={},s=0;s<n;s++)i[s].id==a&&(o=i[s]);if(o.fromUcid===l.core.ucid&&o.sendTime>Date.now()-12e4-l.core.timeOffset){var r=$(l.msgRecallTemplate.render({timestamp:t.data("msgtime"),msgid:a}));if($("[data-msgid="+a+"] .chat-content").find(".msgRecall").length)return;$("[data-msgid="+a+"] .chat-content").append(r)}}).delegate(".chat-msg-recall","click",function(e){var t=$(this).data("msgid");l.core.recallMsg({msg_id:t,conv_id:l.currentConvId,callback:function(e){e?l.core.triggerSyncMsg(l.core.currentSeq):l.showErrorlog("消息撤回失败")}})}),l.rootnode.on("click",function(e){$(".msgRecall").remove()}),l.nodes.talkwindowChatContainer.on("scroll",function(){l.loadHist()}),a=!1,t=function(){setTimeout(function(){a&&l.nodes.pcard.stop().fadeOut(100,function(){l.nodes.pcard.css({top:"9999em",left:"9999em"})})},100)},l.nodes.talkwindow.on("mouseenter",'.chat-in [data-role="im-window-avatar"]',function(){a=!1;var e=$(this),t=l.agentData[l.imData[l.currentConvId].convObj.peer.ucid];t&&(l.updatePcard(t),l.nodes.pcard.css({top:e.position().top-e.height()/2+13+l.nodes.talkwindowMsgContainer.position().top,left:e.position().left+e.width()/2+l.nodes.talkwindowMsgContainer.position().left}).stop().fadeIn(100))}).on("mouseleave",'.chat-in [data-role="im-window-avatar"]',function(){a=!0,t()}),l.nodes.pcard.on("mouseenter",function(){a=!1}).on("mouseleave",function(){a=!0,t()}),l.renderConvList()}),l.initMessageList(),l.imBaseInteractiveInit(i),l.core.initialize()})):this.imBaseInteractiveInit(i),e&&e()}return LianjiaIM.queue={},window.__lianjiaIMVersion="链接 + 表情",LianjiaIM.prototype={constructor:LianjiaIM,clickConvItemTrck:function(){if(!this.core)return!1;this.core.port="im_convlist",this.core.extAttr=null},createTalkTrack:function(e,t){if(!this.core)return!1;this.core.port=e,t&&(this.core.extAttr="string"==typeof t?JSON.parse(t):t)},imBaseInteractiveInit:function(a){var i=this;i.nodes.serviceItemContainer.on("click",function(e){e.preventDefault(),i.showBang(!0,!0),i.nodes.serviceItemContainer.find('[data-role="im-listitem-item-newmsg"]').attr("data-newmsg",0).text(0).hide(),i.updateHeadUnread(),i.firstInitMessageList&&(i.firstInitMessageList=!1,i.bangData.conv_id?(i.userData.code||(i.header["Lianjia-Uuid"]=i.userData.ucid,i.core=new ImCore({msgApiRoot:apiRoot.imApi.msg,mediaApiRoot:apiRoot.imApi.media,apiheader:i.header,appkey:i.pageConf.appkey,ucid:i.userData.ucid}),i.initMessageList(),i.core.initialize()),i.bangData.skillCode?i.bangTalkDisable(!1):(i.bangRenderType(),i.bangTalkDisable(!0)),i.bangShowEnd(!0)):i.userData.code?i.core.create([a.is_ljbb?"SN_LJBB":a.is_bkbb&&"KE_KEFU"],3,function(e){$.isEmptyObject(e)?i.bangRenderSysMsg("会话创建失败"):(i.bangData.conv_id=e.id,i.BangInfoNow={conv_id:e.id},i.updateBangInfo(),i.bangRenderType(),i.initMessageList())}):(i.header["Lianjia-Uuid"]=i.userData.ucid,i.core=new ImCore({msgApiRoot:apiRoot.imApi.msg,mediaApiRoot:apiRoot.imApi.media,apiheader:i.header,appkey:i.pageConf.appkey,ucid:i.userData.ucid}),i.core.create([a.is_ljbb?"SN_LJBB":a.is_bkbb&&"KE_KEFU"],3,function(e){$.isEmptyObject(e)?i.bangRenderSysMsg("会话创建失败"):(i.bangData.conv_id=e.id,i.BangInfoNow={conv_id:e.id},i.updateBangInfo(),i.bangRenderType(),i.initMessageList(),i.core.initialize())})),i.clickConvItemTrck(),"function"==typeof a.userTrack?(a.userTrack({ljweb_mod:"bangbangclick",ljweb_bl:i.userData.code?"1":"0",ljweb_el:"BB120",ljweb_group:1}),a.userTrack({ljweb_mod:"bangbangclick",ljweb_bl:i.userData.code?"1":"0",ljweb_el:"BB120",ljweb_group:1})):(window.LjUserTrack&&LjUserTrack.send&&LjUserTrack.send({ljweb_mod:"bangbangclick",ljweb_bl:i.userData.code?"1":"0",ljweb_el:"BB120",ljweb_group:1}),window.LjUserTrack&&LjUserTrack.send&&LjUserTrack.send({ljweb_mod:"bangbangclick",ljweb_bl:i.userData.code?"1":"0",ljweb_el:"BB120",ljweb_group:1,evt_id:"10190"})))}),i.nodes.talkBangMsgContainer.on("click",'[data-role="bang-type"]',function(){$(this).closest(".chat-block");var e=$(this).data("value"),t=$(this).text();i.bangData.skillCode=e,i.BangInfoNow.skillCode=e,i.updateBangInfo(),i.bangRenderMsg(i.core.encodeHtml(t),!0),i.bangInline()}).on("click",'[data-role="inline-again"]',function(){i.bangRenderType()}),i.sendUrlBang=function(){var e=window.location.href;if(null!==e.match(i.housecardReg)){var t=e.replace(i.housecardReg,"$3");i.getHouseCard(t,function(e){i.core.sendTo(i.bangData.conv_id,{type:1,payload:JSON.stringify(e)},function(e){})},function(){})}else if(null!==e.match(i.xinfangcardReg)){var a=e.replace(i.xinfangcardReg,"$2");i.getXinfangCard(a,function(e){i.core.sendTo(i.bangData.conv_id,{type:6,payload:JSON.stringify(e)},function(e){})},function(){})}else i.core.sendTo(i.bangData.conv_id,{type:99,payload:JSON.stringify({title:"",content:"",url:window.location.href,coverUrl:""})},function(e){})},i.nodes.talkBangMsgContainer.on("mouseenter mouseleave click",".appraise-star",function(e){var t=$(this).closest(".appraise-type-item"),a=t.find(".appraise-star"),i=t.find(".appraise-num"),n=(t.attr("data-value"),+$(this).index()+1);function o(e){e=e||5,i.text(e+"分"),a.removeClass("active").slice(0,e).addClass("active")}"click"==e.type?(t.attr("data-value",n),o(n)):"mouseenter"==e.type?o(n):o(t.attr("data-value"))}),i.nodes.talkBangMsgContainer.on("click",".appraise-btn-submit",function(e){$(this).closest(".bang-appraise").addClass("disabled");var n={callUuid:i.bangData.callUuid};i.nodes.talkBangMsgContainer.find(".appraise-type-item").each(function(e,t){var a=$(this).attr("data-name"),i=$(this).attr("data-value");n[a]=i});var t=$.trim(i.nodes.talkBangMsgContainer.find('[data-role="appraise-textarea"]').val());t&&(n.suggest=t.slice(0,120)),i.nodes.talkBangMsgContainer.find(".bang-appraise").closest("li").remove(),i.bangRenderMsg(i.is_bkbb?"感谢您的评价反馈，贝壳找房将会越来越好。":"感谢您的评价反馈，链家网将会越来越好。"),$.post(apiRoot.satisfaction,n)}),i.nodes.talkBangMsgContainer.on("click",".appraise-btn-cancel",function(e){i.nodes.talkBangMsgContainer.find(".bang-appraise").closest("li").remove(),i.bangRenderMsg("您已取消服务评价")}),i.nodes.talkBangTextarea.on("keydown",function(e){13===e.keyCode&&!1===e.ctrlKey&&(e.preventDefault(),i.nodes.talkBangSend.trigger("click"))}),i.nodes.talkBangSend.on("click",function(){var t=$.trim(i.nodes.talkBangTextarea.val());t&&(i.nodes.talkBangSend.val("发送中...").prop({disabled:!0}),i.sendMsg(i.bangData.conv_id,t,function(e){i.nodes.talkBangSend.val("发送").prop({disabled:!1}),i.nodes.talkBangTextarea.val(""),i.bangRenderMsg(i.core.encodeHtml(t),!0)}))}),i.nodes.talkBangEnd.on("click",function(e){i.bangTalkDisable(!0),i.bangHangup(i.bangData.conv_id,function(){i.bangRenderSysMsg('<span>您挂断了通话</span><span class="btn-handle" data-role="inline-again">重新进线</span>'),i.bangRenderAppraise()})}),i.nodes.picBtnBang.on("click",function(){i.nodes.picInputBang.trigger("click")}),i.nodes.picInputBang.on("change",function(e){i.sendPic(i.bangData.conv_id,i.nodes.picInputBang[0].files[0],function(e){if(e){var t=JSON.parse(e.payload);i.bangRenderPic(t,!0)}else i.bangRenderSysMsg("图片发送失败")})}),$body.on("click.lianjiaim",'a[data-role="lianjiaim-createtalk"]',function(e){e.preventDefault();var t=$(this);i.initTalk(t.attr("data-ucid"),t.data("source-port")),i.createTalkTrack(t.data("source-port"),t.data("source-extends")),"function"==typeof a.userTrack?(a.userTrack({ljweb_mod:"imclick",ljweb_bl:i.userData.code?"1":"0",ljweb_el:t.attr("data-ucid"),ljweb_group:1}),a.userTrack({ljweb_mod:"imclick",ljweb_bl:i.userData.code?"1":"0",ljweb_el:t.attr("data-ucid"),ljweb_group:1,evt_id:"10190"})):(window.LjUserTrack&&LjUserTrack.send&&LjUserTrack.send({ljweb_mod:"imclick",ljweb_bl:i.userData.code?"1":"0",ljweb_el:t.attr("data-ucid"),ljweb_group:1}),window.LjUserTrack&&LjUserTrack.send&&LjUserTrack.send({ljweb_mod:"imclick",ljweb_bl:i.userData.code?"1":"0",ljweb_el:t.attr("data-ucid"),ljweb_group:1,evt_id:"10190"}))}),$body.append(this.rootnode),this.nodes.head.on("click",function(e){"function"==typeof a.userTrack&&a.userTrack({event:"openIm",target:i.isFolding}),i.fold(!i.isFolding)}),i.nodes.is_accuse.on("click",function(e){i.nodes.cover.show(),i.nodes.accuseModal.show(),"举报"===i.nodes.accuseText.html()?(i.nodes.setAccuse.show(),i.nodes.cancelAccuse.hide()):(i.nodes.setAccuse.hide(),i.nodes.cancelAccuse.show())}),i.nodes.closeModal.on("click",function(e){i.nodes.accuseModal.hide(),i.nodes.cover.hide()}),i.nodes.accuseType.on("click",function(e){i.is_accuse=e.target.value,i.accuseType=1}),i.nodes.confirm.on("click",function(e){var t={type:2===i.accuseType?"TONGYE":i.is_accuse,ucid:i.imData[i.currentConvId].convObj.peer.ucid,op_type:i.accuseType};i.core&&i.core.accuse(t,function(e){if(0===e.errno)if(1===i.accuseType){i.nodes.accuseText.html("取消举报"),i.nodes.reportCelling.show(),i.nodes.reportText.html("您已将TA标注为"+{WEISHANG:"微商",TONGYE:"同业",SAORAO:"骚扰"}[i.is_accuse]),i.accuseType=2}else i.nodes.accuseText.html("举报"),i.nodes.reportCelling.hide(),i.accuseType=1;i.nodes.closeModal.trigger("click")})}),i.nodes.talkBang.on("click",'[data-role="bang-close"]',function(){i.currentConvId="",i.showBang(!1)})},getUcData:function(e,t){t=t||_util.noop,"string"==typeof e&&(e=[e]),this.core.getUsersInfo({ucids:e.join(",")},t)},updateArrive_Read:function(e){var t=[],a=null;this.currentConvId&&this.imData[this.currentConvId]&&(t=this.imData[this.currentConvId].msgList,a=this.imData[this.currentConvId].readInfo);var i=0;if(e.isFormOther&&this.currentConvId){i=a?a.read:t[t.length-1].readMsgId,$(".chat-content .readState").remove();var n=document.createElement("div");n.innerText="已读",n.className="readState",$("[data-msgid="+i+"] .chat-content").append(n)}},filterSupportMsg:function(e){var a=[],i=[-1,-2,-6,1,2,3,7,5,6,99,8,105,109,211,310,320,330,400,120,121,600,122,123,124,125,800,802,804];return $.each(e,function(){var t=this;i.some(function(e){return e===t.type})&&a.push(t)}),a},getMsgSummary:function(e){var t="";if(e)switch(e.type){case-1:t=e.payload;break;case-2:t="[图片]";break;case 105:t="[自动回复]"+e.payload;break;case 109:t="["+(JSON.parse(e.payload).emoticonName||"表情")+"]";break;case 1:t="[房源]";break;case 6:t="[楼盘]";default:t=e.summary}return t},showIM:function(){this.fold(!1)},hideIM:function(){$("div.lianjiaim-wrap").hide(),this.fold(!0)},on:function(e,t){LianjiaIM.queue[e]||(LianjiaIM.queue[e]=[]),LianjiaIM.queue[e].push(t)},off:function(e,t){if(LianjiaIM.queue[e]){var a=LianjiaIM.quenen[e].indexOf(t);LianjiaIM.queue[e].splice(a,1)}},emit:function(e){var t=LianjiaIM.queue[e];if(t)for(var a=0;a<t.length;a++)"IMUnReadMsgNum"===e?t[a](this.unreadSum):t[a]()},initTalk:function(e){var s=this,t=arguments,r="",a="",d="",c="",l="";if(this.userData.code){var i=Object.prototype.toString.call(t[0]);if("[object Object]"===i?(r=e.ucid||"",a=e.port||"",d=e.msgPayload,c=e.scheme,l=e.push_content||"你有一条新消息",this.core&&(this.core.extAttr=JSON.parse(e.extends||"null"))):"[object String]"===i&&(r=t[0]||"",a=t[1]||"im",this.core&&(this.core.extAttr=JSON.parse(t[2]||"null"))),r!==this.userData.ucid&&""!==r){this.core&&(this.core.port=a);var u=~this.publicAccounts.indexOf(r),n=u?3:1;this.core&&this.core.create(r,n,function(e){if(null!==e){if(s.updateImDataConv(e.id,"convObj",e),null===s.imData[e.id].itemNode&&s.addConvItemNode(s.imData[e.id].convObj),s.fold(!1),s.setWindow(e.id),s.showWindow(!0),s.scrollWindow("btm"),u&&s.core.convEnter(e.id),c&&s.sendCard(c,l),d&&s.sendMsg(e.id,d,function(e){$.isEmptyObject(e)&&s.showErrorlog("消息发送失败")}),null!==window.location.href.match(s.housecardReg)){var t=window.location.href.replace(s.housecardReg,"$3");s.housecardStat.check(r,t)&&s.sendMsg(e.id,window.location.href,function(e){s.housecardStat.set(r,t),$.isEmptyObject(e)&&s.showErrorlog("消息发送失败")},!1,1)}if(null!==window.location.href.match(s.xinfangcardReg)){var a=window.location.href.replace(s.xinfangcardReg,"$2"),i=window.location.href.replace(s.xinfangcardReg,"$3");if("wenda"===a&&-1==i.indexOf("project_name"))return;s.housecardStat.check(r,a)&&s.sendMsg(e.id,window.location.href,function(e){s.housecardStat.set(r,a),$.isEmptyObject(e)&&s.showErrorlog("消息发送失败")})}if(null!==window.location.href.match(s.ke_ershouCardReg)){var n=window.location.href.replace(s.ke_ershouCardReg,"$2");s.housecardStat.check(r,n)&&s.sendMsg(e.id,window.location.href,function(e){s.housecardStat.set(r,n),$.isEmptyObject(e)&&s.showErrorlog("消息发送失败")})}if(null!==window.location.href.match(s.chengjiao_ershouCardReg)){var o=window.location.href.replace(s.chengjiao_ershouCardReg,"$2");s.housecardStat.check(r,o)&&s.sendMsg(e.id,window.location.href,function(e){s.housecardStat.set(r,o),$.isEmptyObject(e)&&s.showErrorlog("消息发送失败")})}}else s.showErrorlog("会话创建失败")})}}else this.login&&"[object Function]"===Object.prototype.toString.call(this.login)?this.login():"undefined"!=typeof login?login.openLoginDialog&&login.openLoginDialog():alert("请先登录再开始聊天！")},sendMsg:function(i,e,n,t,a){n=n||_util.noop;var o=this;if(0<$.trim(e).length)if(t||null===e.match(this.housecardReg))if(t||null===e.match(o.xinfangcardReg))if(t||null===e.match(o.zulincardReg))if(t||null===e.match(o.ke_ershouCardReg)&&null===e.match(o.chengjiao_ershouCardReg)){var s=e,r=null;500<s.length&&(s=e.slice(0,500),r=e.slice(500)),this.core.sendTo(i,{type:-1,localId:+new Date,payload:this.core.encodeHtml(s)},function(e,t,a){null!==r?o.sendMsg(i,r,n):n(e,a)})}else{d=e.match(o.ke_ershouCardReg)||e.match(o.chengjiao_ershouCardReg),c={oriMsg:e,beforeMsg:d[1]||"",house_code:d[2]||"",afterMsg:d[3]||""};this.sendKeErshouCard(i,c,n)}else{var d=e.match(o.zulincardReg),c={oriMsg:e,beforeMsg:d[1]||"",house_code:d[2]||""};this.sendZulincard(i,c,n)}else{var l="",u=e.replace(o.xinfangcardReg,"$2"),p=e.replace(o.xinfangcardReg,"$3");l="wenda"===u?p.substring(p.indexOf("=")+1):u;var h={oriMsg:e,beforeMsg:e.replace(o.xinfangcardReg,"$1"),project_name:l};this.sendXinfangcard(i,h,n,a)}else{var c={oriMsg:e,beforeMsg:e.replace(this.housecardReg,"$1"),houseType:e.replace(this.housecardReg,"$2"),houseCode:e.replace(this.housecardReg,"$3")};this.sendHousecard(i,c,n)}else n({noSend:!0})},sendCard:function(e,t,a){var i=this,n={scheme:e,desc:"[[您收到一条消息，请升级APP版本后查看]]",push_content:t};i.send330Msg(i.currentConvId,n,function(e){var t={msg_id:e.data.msg_id,conv_id:e.data.conv_id,scheme:n.scheme};i.init330card(t,i.core.ucid),a&&a()})},sendPic:function(n,e,o){o=o||_util.noop,this.core.uploadPicture(n,e,function(e,t){var a=JSON.parse(e),i=t.encodeHtml(a.original);a.original=i,t.sendTo(n,{type:-2,payload:JSON.stringify(a)},function(e){o(e)})})},sendHousecardMsg:function(e,t,a){a=a||_util.noop,this.core.sendTo(e,{type:1,localId:+new Date,payload:JSON.stringify(t)},function(e){a(e)})},sendHousecard:function(t,a,i){i=i||_util.noop;var n=this;n.getHouseCard(a.houseCode,function(e){n.sendMsg(t,a.beforeMsg,function(){n.sendHousecardMsg(t,e,function(e){i(e)})})},function(){throw n.showErrorlog("无法获取房源卡片信息"),n.sendMsg(t,a.oriMsg,function(){i()},!0),new Error("无法获取房源卡片信息")})},getHouseCard:function(e,a,i){$.ajax({url:_util.apiUrl("house/house/gethousecard"),data:{house_code:e},dataType:"jsonp",success:function(e){if(0===e.errno){var t={houseCode:e.data.house_code,houseName:e.data.title,houseImgUrl:e.data.cover_pic,houseHallCount:e.data.blueprint_hall_num,houseBedroomCount:e.data.blueprint_bedroom_num,area:e.data.area,price:e.data.price,orientation:e.data.orientation,schemeUrl:e.data.m_url};switch(e.data.house_type){case"ershoufang":case"sell":t.houseType=1;break;case"zufang":case"rent":t.houseType=1}switch(e.data.house_state){case"zai_shou":t.houseState=1;break;case"yi_shou":t.houseState=2;break;case"ting_shou":t.houseState=3}a&&a(t)}else i&&i()}})},sendXinfangcardMsg:function(e,t,a){a=a||_util.noop,this.core.sendTo(e,{type:6,localId:+new Date,payload:JSON.stringify(t)},function(e){a(e)})},sendXinfangcard:function(t,a,i,e){i=i||_util.noop;var n=this;n.getXinfangCard(a.project_name,function(e){n.sendMsg(t,a.beforeMsg,function(){n.sendXinfangcardMsg(t,e,function(e){i(e)})})},function(e){throw n.showErrorlog("无法获取房源卡片信息"),n.sendMsg(t,a.oriMsg,function(){i()},!0),new Error("无法获取房源卡片信息")},e)},getXinfangCard:function(e,a,i,n){$.ajax({url:_util.xinfangUrl("newhouse/api/resblock/imcard"),data:{project_name:e.replace("p_",""),source:1},type:"get",dataType:"json",success:function(e){if(0===e.errno){var t={buildingId:e.data.resblock_id,buildingName:e.data.resblock_name,buildingImgUrl:e.data.image_url,avgPrice:e.data.show_price_info,area:e.data.area,roomType:e.data.room_type,houseType:e.data.house_type,address:e.data.address_desc,cityCode:e.data.city_code,projectName:e.data.project_name,schemeUrl:e.data.pc_url,fromType:n?1:0};a&&a(t)}else i&&i()},error:function(e){i&&i(e)}})},sendZulincardMsg:function(e,t,a){a=a||_util.noop,this.core.sendTo(e,{type:1,localId:+new Date,payload:JSON.stringify(t)},function(e){a(e)})},sendZulincard:function(t,a,i,e){i=i||_util.noop;var n=this;n.getZulincard(a.house_code,function(e){n.sendMsg(t,a.beforeMsg,function(){n.sendZulincardMsg(t,e,function(e){i(e)})})},function(e){throw n.showErrorlog("无法获取房源卡片信息"),n.sendMsg(t,a.oriMsg,function(){i()},!0),new Error("无法获取房源卡片信息")},e)},getZulincard:function(e,n,o,t){function a(e,t){var a=[];return $.each(e,function(e,t){a.push(e+"="+t)}),a.sort(),a.join(t)}var i={house_code:e,ts:(Date.now()/1e3).toFixed(0)},s=a(i,"&"),r=a(i,"");$.ajax({url:_util.zulinUrl("v1/house/baseinfo")+"?"+s+"&rent_sign="+md5("74bd10b352473fd0ebac140dc9585581"+r+"v1/house/baseinfo")+"&rent_app_id=lianjiaIM",data:{},dataType:"json",success:function(e){if(0===e.status){var t=e.data||{},a=t.layout&&t.layout.match(/(\d+)室(\d+)厅(\d+)卫/)||[],i={houseCode:t.house_code,houseType:2,houseName:t.house_title,houseImgUrl:t.list_picture,houseHallCount:parseInt(a[2],10)||0,houseBedroomCount:parseInt(a[1],10)||0,area:parseFloat(t.rent_area,10)||0,price:parseFloat(t.rent_price_listing,10)||0,orientation:t.frame_orientation,schemeUrl:t.pc_landing_page};n&&n(i)}else o&&o()},error:function(e){o&&o(e)}})},send330Msg:function(e,t,a){a=a||_util.noop,this.core.send330(e,{type:330,localId:+new Date,payload:JSON.stringify(t)},function(e){a(e)})},init330card:function(o,s){var r=this;this.core.get330card(o,function(e){var t=e.data,a=t.uiModel,i=$("li.card330."+o.msg_id);if(2===t.cardID)i.find(".type-1").hide(),i.find(".type-cardId1").hide(),i.find(".type-3").show(),i.find(".type-3-label").show(),i.find(".house-card").attr("href",t.webScheme),i.find(".im-housecard-img").html('<img style="height: 110px; width: 200px;" src='+a.imageUrl+" />"),i.find(".im-housecard-title").text(a.textTitle),i.find(".im-housecard-info").text(a.textContent1),i.find(".im-housecard-price").text(a.textContent2),i.find(".im-housecard-label").text(a.label);else if(1===t.cardID){i.find(".type-1").hide(),i.find(".type-3").hide(),i.find(".type-3-label").hide(),i.find(".type-cardId1").show(),i.find(".im-phonecard-title").text(a.title),i.find(".im-phonecard-desc").text(a.summary);var n=i.find(".im-phonecard-btns");r.core.ucid==s?n.hide():(n.find(".im-phonecard-btn1").on("click",function(e){var t=e.target.dataset;r.update330PhoneCard({msg_id:t.msg_id,conv_id:t.conv_id,scheme:t.scheme},n)}),n.find(".im-phonecard-btn1").text(a.buttons[0].text).attr({"data-msg_id":o.msg_id,"data-conv_id":o.conv_id,"data-scheme":a.buttons[0].action}).css({color:a.buttons[0].textColor}),a.buttons[1]?(n.find(".im-phonecard-btn2").on("click",function(e){var t=e.target.dataset;r.update330PhoneCard({msg_id:t.msg_id,conv_id:t.conv_id,scheme:t.scheme},n)}),n.find(".im-phonecard-btn2").text(a.buttons[1].text).attr({"data-msg_id":o.msg_id,"data-conv_id":o.conv_id,"data-scheme":a.buttons[1].action}).css({color:a.buttons[1].textColor})):n.find(".im-phonecard-btn2").hide())}else i.find(".type-1").show(),i.find(".type-3").hide(),i.find(".type-cardId1").hide(),i.find(".type-3-label").hide()})},update330PhoneCard:function(e,a){e.scheme&&this.core.get330card(e,function(e){var t=e.data.uiModel;a.find(".im-phonecard-btn1").text(t.buttons[0].text).attr({"data-scheme":t.buttons[0].action}).css({color:t.buttons[0].textColor}),t.buttons[1]?a.find(".im-phonecard-btn2").text(t.buttons[1].text).attr({"data-scheme":t.buttons[1].action}).css({color:t.buttons[1].textColor}):a.find(".im-phonecard-btn2").hide()})},sendKeErshouCard:function(t,a,i,e){i=i||_util.noop;var n=this;n.getKeErshouCard(a.house_code,function(e){n.sendMsg(t,a.beforeMsg,function(){n.sendHousecardMsg(t,e,function(e){i(e)})})},function(e){throw n.showErrorlog("无法获取房源卡片信息"),n.sendMsg(t,a.oriMsg,function(){i(e)},!0),new Error("无法获取房源卡片信息")},e)},getKeErshouCard:function(e,i,n,t){$.ajax({url:_util.ke_ershouUrl("info/cardinfo"),data:{type:"pc",source:"im",houseCode:e,token:md5(e+"im_fds1324ere][;4%7!390")},type:"GET",dataType:"jsonp",success:function(e){if(0===e.error_code){var t=e.data||{},a={houseCode:t.houseCode,houseType:t.houseType||1,isPriceOnly:t.isPriceOnly,houseName:t.houseName,houseImgUrl:t.houseImgUrl,houseHallCount:t.houseHallCount,houseBedroomCount:t.houseBedroomCount,area:t.area,price:t.price,houseState:t.houseState,orientation:t.orientation,schemeUrl:t.schemeUrl};i&&i(a)}else n&&n()},error:function(e){n&&n(e)}})},fold:function(e){e!==this.isFolding&&((this.isFolding=e)?(this.rootnode.addClass("im-fold"),this.showWindow(!1),this.showBang(!1)):(this.rootnode.removeClass("im-fold"),this.visibleBang?this.showBang(!0):""!==this.currentConvId&&this.showWindow(!0)))},showWindow:function(e){this.scrollWindow("btm"),this.nodes.talkwindow[e?"show":"hide"](),e&&(this.visibleBang=!1,this.showBang(!1)),this.nodes.is_accuse.is(":visible")?this.nodes.topText.hide():this.nodes.topText.show()},showBang:function(e,t){e&&(this.visibleBang=!0),this.nodes.talkBang[e?"show":"hide"](),e&&this.showWindow(!1),t&&(this.rootnode.removeClass("im-fold"),this.isFolding=!1),this.scrollBangWindow("bottom")},scrollWindow:function(e){switch(e){case"top":this.nodes.talkwindowChatContainer.scrollTop(0);break;case"btm":this.nodes.talkwindowChatContainer.scrollTop(this.nodes.talkwindowMsgContainer.height());break;default:this.nodes.talkwindowChatContainer.scrollTop(e)}},renderConvList:function(e){var i=this;e||(e=i.imData),i.nodes.listItemContainer.html("");var a=[],n=0;$.each(e,function(e,t){(1===t.convObj.type||3===t.convObj.type&&-1<i.publicAccount.indexOf(t.convObj.peer.ucid))&&a.push(t)}),a.sort(function(e,t){return e.convObj.mTime-t.convObj.mTime}),$.each(a,function(e,t){var a=t.convObj;i.addConvItemNode(a),n++}),0<n?(i.nodes.noagentContainer.hide(),i.nodes.listItemContainer.show()):(i.nodes.listItemContainer.hide(),i.nodes.noagentContainer.show())},updateImDataConv:function(e,t,a){this.imData[e]||(this.imData[e]={convObj:null,msgList:[],itemNode:null,readMsgId:0,hasHistory:!0});var i=this.imData[e];switch(t){case"convObj":i.convObj=a;break;case"msgList":i.msgList=a;break;case"itemNode":i.itemNode=a;break;case"readMsgId":i.readMsgId=a;break;case"hasHistory":i.hasHistory=a}},addConvItemNode:function(e){if(!(!e||!e.peer||e.peer&&"SN_LJBB"===e.peer.ucid||e.peer&&"KE_KEFU"===e.peer.ucid||2===e.type||3===e.type&&-1===this.publicAccount.indexOf(e.peer.ucid))){var t=$(this.listItemTemplate.render({item:{user_status:1,convId:e.id,convType:e.type,id:e.peer.ucid,name:e.title,avatar:e.avatar,summary:this.core.encodeHtml(e.summary)}}));this.updateImDataConv(e.id,"itemNode",t),this.nodes.listItemContainer.prepend(t),this.updateConvItemNode(e.id,{text:e.lastMsg,time:e.mTime})}},updateConvItemNode:function(e,t,a){var i=this.imData[e].itemNode;if(i){var n=i.find('[data-role="im-listitem-item-newmsg"]'),o=+n.attr("data-newmsg");t.text&&i.find('[data-role="im-listitem-item-text"]').html(this.core.encodeHtml(t.text)),t.time&&i.find('[data-role="im-listitem-item-time"]').html(_util.timeFormat(t.time,"deltaTime","YYYY-MM-DD")),void 0!==t.newmsgAmount&&("string"==typeof t.newmsgAmount&&null!==t.newmsgAmount.match(/\+/g)?o+=+t.newmsgAmount.replace(/\+/g,""):"number"==typeof t.newmsgAmount&&(o=t.newmsgAmount),n.attr({"data-newmsg":o}).html(o<=99?o:"99+"),0<o?n.show():n.hide()),a&&this.nodes.listItemContainer.prepend(i)}},updateHeadUnread:function(){var e=0;$.each(this.nodes.listItemContainer.find('[data-role="im-listitem-item"]'),function(){e+=+$(this).find('[data-role="im-listitem-item-newmsg"]').attr("data-newmsg")}),this.is_ljbb&&(e+=+this.nodes.serviceItemContainer.find('[data-role="im-listitem-item-newmsg"]').attr("data-newmsg")),this.nodes.headUnread.attr({"data-newmsg":e}).html(e<=99?e:"99+"),0<e?this.nodes.headUnread.show():this.nodes.headUnread.hide(),this.unreadSum=e,this.emit("IMUnReadMsgNum")},updatePcard:function(e){var t=function(e,t,a){return null===e?t:a?a.replace(/<r>/g,e):e};this.nodes.pcard.find('[data-role="im-pcard-avatar"]').attr({src:e.photo_url.replace(/\d+x\d+/g,"78x78")}),this.nodes.pcard.find('[data-role="im-pcard-name"]').html(e.name),this.nodes.pcard.find('[data-role="im-pcard-grade"]').html(t(e.agent_level,"")),this.nodes.pcard.find('[data-role="im-pcard-district"]').html(t(e.bizcircle_name,"暂无")),this.nodes.pcard.find('[data-role="im-pcard-store"]').html(t(e.shop_name,"暂无")),this.nodes.pcard.find('[data-role="im-pcard-workage"]').html(t(e.job_year,"暂无")),this.nodes.pcard.find('[data-role="im-pcard-totaldeal"]').html(t(e.house_sold_count,"暂无")),this.nodes.pcard.find('[data-role="im-pcard-monthshow"]').html(t(e.recent_see,"暂无")),this.nodes.pcard.find('[data-role="im-pcard-praiserate"]').html(t(e.review_good_rate,"暂无","<r>%")),this.nodes.pcard.find('[data-role="im-pcard-shoplink"]').attr({href:"https://dianpu.lianjia.com/"+e.agent_ucid})},setWindow:function(e){var t=this,a=this.imData[e],i=a.convObj,n=i.peer.type,o=i.peer.ucid,s=this.filterSupportMsg(a.msgList);this.currentConvId=+e,this.nodes.talkwindowMsgContainer.html(""),this.nodes.inputTextarea.val(""),this.nodes.talkwindow.find('[data-role="im-window-name"]').html(i.title),0<s.length?this.addMsg(s,"btm"):this.loadHist(!0),1===n&&(this.agentData[o]||$.ajax({url:_util.apiUrl("im/agent/getagentdetail"),data:{agent_ucid:o},dataType:"jsonp",success:function(e){t.agentData[o]=e.data}})),t.updateConvItemNode(e,{newmsgAmount:0}),t.updateHeadUnread()},loadHist:function(n){var o=this;if(!o.isLoadingHistory&&0===o.nodes.talkwindowChatContainer.scrollTop()){var s=o.currentConvId,e=o.imData[o.currentConvId].msgList[0],t=0;if(e){if(1===e.id||!1===o.imData[o.currentConvId].hasHistory)return;t=e.sendTime}o.isLoadingHistory=!0,o.core.getHistory({conv_id:s,max_send_time:t,limit:100},function(e){if(null!==e){var t=o.filterSupportMsg(e);o.updateImDataConv(s,"msgList",e.reverse().concat(o.imData[s].msgList));var a=o.nodes.talkwindowMsgContainer.find("li.chat-block").eq(0);o.addMsg(t,"top");var i=o.nodes.talkwindowMsgContainer.find("li.chat-block").eq(0);n?o.scrollWindow("btm"):a[0]&&i[0]&&o.scrollWindow(a[0].getBoundingClientRect().top-i[0].getBoundingClientRect().top),0!==e.length&&1!==e[0].id||o.updateImDataConv(s,"hasHistory",!1)}else o.showErrorlog("获取历史记录失败");o.isLoadingHistory=!1})}},addMsg:function(e,m){var g=this;0<e.length&&($.each(e,function(){var e=this,t=null,a=null;if(!(0<g.nodes.talkwindowMsgContainer.find('[data-msgid="'+e.id+'"]').length)){var i="",n="",o="";switch(o=g.userData.ucid===e.fromUcid?(i="chat-out",n=g.userData.name,g.userData.avatar||g.staticRoot+"/pc/asset/lianjiaIM/img/icon_user@2x.png"):(i="chat-in",n=g.imData[e.convId].convObj.title,g.imData[e.convId].convObj.avatar||g.staticRoot+"/pc/asset/img/jingjiren/noimg.jpg"),e.type){case-1:case 105:t=$(g.messageNodeTemplate.render({sendType:i,timestamp:e.sendTime,msgid:e.id,user:{username:n,avatar:o},message:{text:_util.httpHtml(e.payload)}}));break;case-2:var s=JSON.parse(e.payload);s=g.isValidHouseUrl(s,["original","thumbnail"]),t=$(g.picNodeTemplate.render({sendType:i,timestamp:e.sendTime,msgid:e.id,user:{username:n,avatar:o},pic:{url:g.core.encodeHtml(s.original),thumb:g.core.encodeHtml(s.thumbnail),desc:"图片"}}));break;case 109:t=$(g.picNodeTemplate.render({sendType:i,timestamp:e.sendTime,msgid:e.id,user:{username:n,avatar:o},pic:{url:JSON.parse(e.payload).emoticonRemoteUrl,thumb:JSON.parse(e.payload).emoticonRemoteUrl,desc:JSON.parse(e.payload).emoticonName}}));break;case 1:var r=JSON.parse(e.payload);r.houseImgUrl&&null!==r.houseImgUrl.match(/http/g)||(r.houseImgUrl=g.staticRoot+"/pc/asset/img/new-version/default_block.png"),1===r.isPriceOnly?r.priceUnit="万起":r.priceUnit="万",3!=r.houseType&&2!=r.houseType||(r.price=1e4*r.price,r.priceUnit="元/月"),r=g.isValidHouseUrl(r,["schemeUrl"]),t=$(g.housecardNodeTemplate.render({sendType:i,timestamp:e.sendTime,msgid:e.id,user:{username:n,avatar:o},houseinfo:r}));break;case 6:var d=JSON.parse(e.payload);d.houseImgUrl&&null!==d.houseImgUrl.match(/http/g)||(d.houseImgUrl=g.staticRoot+"/pc/asset/img/new-version/default_block.png"),d=g.isValidHouseUrl(d,["schemeUrl"]),t=$(g.xinfangcardNodeTemplate.render({sendType:i,timestamp:e.sendTime,msgid:e.id,user:{username:n,avatar:o},houseinfo:d}));break;case 330:var c={msg_id:e.id,conv_id:e.convId,scheme:JSON.parse(e.payload).scheme};t=$(g.msg330NodeTemplate.render({sendType:i,timestamp:e.sendTime,msgid:e.id,user:{username:n,avatar:o}})),g.init330card(c,e.fromUcid);break;case 600:if((p=JSON.parse(e.payload)).content&&2===p.type){var l=p.content&&p.content.message||p.desc;1===p.content.sessionStatus&&(t=$(g.messageNodeTemplate.render({sendType:i,timestamp:e.sendTime,msgid:e.id,user:{username:n,avatar:o},message:{text:_util.httpHtml(l)}})))}else{l=p.content&&p.content.message||p.desc;t=$(g.msg802NodeTemplate.render({sendType:"system",timestamp:e.sendTime,msgid:e.id,desc:l}))}break;case 802:var u=JSON.parse(e.payload);g.nodes.talkwindowMsgContainer.find("li.chat-block[data-msgid="+u.msg_id+"]").remove(),t=$(g.msg802NodeTemplate.render({sendType:"system",timestamp:e.sendTime,msgid:e.id,desc:u.desc}));break;default:t=$(g.messageNodeTemplate.render({sendType:i,timestamp:e.sendTime,msgid:e.id,user:{username:n,avatar:o},message:{text:g.core.encodeHtml(e.type+"-暂不支持消息类型，请前往app查看")}}))}if(t){var p;if(t.data({msgData:e}),600===e.type)if((p=JSON.parse(e.payload)).content&&2===p.type&&1===p.content.sessionStatus){var h=$(g.msg802NodeTemplate.render({sendType:"system",timestamp:e.sendTime,msgid:e.id,desc:"已为您接通客服"}));h.data({msgData:e}),g.nodes.talkwindowMsgContainer.append(h)}"btm"===m?((0===(a=g.nodes.talkwindowMsgContainer.find("li.chat-block:last")).length||6e4<e.sendTime-a.data("msgData").sendTime)&&802!==e.type&&g.nodes.talkwindowMsgContainer.append(g.chatTimeNodeTemplate.render({time:_util.timeFormat(e.sendTime,"deltaTime","YYYY-MM-DD hh:mm")})),g.nodes.talkwindowMsgContainer.append(t)):"top"===m&&(a=g.nodes.talkwindowMsgContainer.find("li.chat-block:first"),g.nodes.talkwindowMsgContainer.prepend(t),(0===a.length||e.sendTime-a.data("msgData").sendTime<-6e4)&&802!==e.type&&g.nodes.talkwindowMsgContainer.prepend(g.chatTimeNodeTemplate.render({time:_util.timeFormat(e.sendTime,"deltaTime","YYYY-MM-DD hh:mm")})))}}}),this.addRead(e.slice(-1)[0]))},addRead:function(e){e.fromUcid!==this.userData.ucid&&0<e.id&&e.id>this.imData[e.convId].readMsgId&&(this.updateImDataConv(e.convId,"readMsgId",e.id),this.core.markRead(e))},isValidHouseUrl:function(e,t){if("object"==typeof t)for(var a=t.length,i=0;i<a;i++)e&&!this.validUrl.test(e[t[i]])&&(e[t[i]]=location.href);else"string"==typeof t&&e&&!this.validUrl.test(e[t])&&(e[t]=location.href);return e},showErrorlog:function(e){var t=this;clearTimeout(this.errorlogTimer),this.nodes.errorlogContainer.hide().html(e).fadeIn(200,function(){t.errorlogTimer=setTimeout(function(){t.nodes.errorlogContainer.fadeOut(200,function(){t.nodes.errorlogContainer.html("")})},2e3)})}},Tr=document.createElement("style"),Tr.innerText=".im-housecard img{vertical-align: baseline;}.readState{ color: #9c9fa1; position: absolute;bottom: -18px;right: 0;font-size: 12px;}.im-wc-chat .chat-out .chat-content{ position: relative; }.msgRecall{ position: absolute;bottom: -20px;right: 0; color:#101d37;background: ghostwhite;border-radius: 2px;cursor: pointer; padding: 0 10px;}",document.body.appendChild(Tr),LianjiaIM});